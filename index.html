<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>一只程序猿的博客</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一切都是可以改变的，不可能只有庸人的词典里才有">
<meta property="og:type" content="website">
<meta property="og:title" content="一只程序猿的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="一只程序猿的博客">
<meta property="og:description" content="一切都是可以改变的，不可能只有庸人的词典里才有">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一只程序猿的博客">
<meta name="twitter:description" content="一切都是可以改变的，不可能只有庸人的词典里才有">
  
    <link rel="alternative" href="/atom.xml" title="一只程序猿的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
  

  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
      <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("MW2iyQz6scY0XFrHP96SRKVb-gzGzoHsz", "9thbl1JAC6FeVjyjSEXHYBD1");</script>
<script src="/js/Counter.js"></script>
  
</head></html>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/yzcxy.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">一只程序猿</a></h1>
		</hgroup>

		
		<p class="header-subtitle">一切都是可以改变的，不可能只有庸人的词典里才有</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/hanfeng529264" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/hf529264@163.com" title="mail">mail</a>
					        
								<a class="qq" target="_blank" href="/2286670111" title="qq">qq</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/hanfeng0310" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://keveon.me">keveon.me</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://pqsky.me">pqsky.me</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
	
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">一只程序猿</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/yzcxy.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">一只程序猿</h1>
			</hgroup>
			
			<p class="header-subtitle">一切都是可以改变的，不可能只有庸人的词典里才有</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/hanfeng529264" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/hf529264@163.com" title="mail">mail</a>
			        
						<a class="qq" target="_blank" href="/2286670111" title="qq">qq</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/hanfeng0310" title="weibo">weibo</a>

					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-html 转换成 pdf" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/04/17/html 转换成 pdf/" class="article-date">
  	<time datetime="2018-04-16T16:00:00.000Z" itemprop="datePublished">2018-04-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/17/html 转换成 pdf/">
        html 转换成 pdf
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>不久前有个需求，需要将 <code>html</code> 格式文件转换成 <code>PDF</code> 格式文件，学习 <code>java</code> 的都知道，有个组件可以帮我们完成这项工作——<code>itext</code>。<br>但是请注意的是（亲测）：<code>itext</code> 做简单的 <code>html</code> 转换还可以，但是如果页面相对比较复杂的时候，<code>itext</code> 表现的就不尽人意了。<br>然后上网查阅，找到一个比较不错的工具——<code>wkhtmltopdf</code>，和大家分享下</p>
<p><a href="http://wkhtmltopdf.org/" target="_blank" rel="noopener">官网地址戳这里</a></p>
<p><code>wkhtmltopdf</code> 把 <code>html</code> 转成 <code>pdf</code> 很简单，只要在 windows 命令行中输入<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c:\wkhtmltopdf.exe http:<span class="comment">//www.baidu.com c:\cnblogs.pdf</span></span><br></pre></td></tr></table></figure></p>
<p>就可以把百度网页转成pdf，并保存到C盘根目录（路径可以自己指定，这个不像多说什么）。<br>在 <code>Java</code> 中调用 <code>wkhtmltopdf</code> 的命令<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="string">"c:\wkhtmltopdf.exe http://www.cnblogs.com c:\cnblogs.pdf"</span>)</span><br></pre></td></tr></table></figure></p>
<p>就可以实现转换。<br>下面把命令封装成java工具类，方便调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.thunisoft.dzjz.material.converter.html;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hanfeng on 2018-4-16.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 4.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Html2Pdf</span> </span>&#123;</span><br><span class="line">    <span class="comment">// wkhtmltopdf 在本地的安装路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String toPdfTool = <span class="string">"D:\\wkhtmltopdf\\bin\\wkhtmltopdf.exe"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * html转pdf</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> srcPath html路径，可以是硬盘上的路径，也可以是网络路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> destPath pdf保存路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 转换成功返回true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">convert</span><span class="params">(String srcPath, String destPath)</span></span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(destPath);</span><br><span class="line">        File parent = file.getParentFile();</span><br><span class="line">        <span class="comment">//如果pdf保存路径不存在，则创建路径</span></span><br><span class="line">        <span class="keyword">if</span>(!parent.exists())&#123;</span><br><span class="line">            parent.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        StringBuilder cmd = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        cmd.append(toPdfTool);</span><br><span class="line">        cmd.append(<span class="string">" "</span>); <span class="comment">//  注意  前后的这个空命令行不能删，否则会报错</span></span><br><span class="line"><span class="comment">//        cmd.append("--page-size A4 ");// 指定纸张大小</span></span><br><span class="line"><span class="comment">//        cmd.append("  --header-line");//页眉下面的线</span></span><br><span class="line"><span class="comment">//        cmd.append("  --header-center 这里是页眉这里是页眉这里是页眉这里是页眉 ");//页眉中间内容</span></span><br><span class="line">        <span class="comment">//设置页面上边距 (default 10mm)</span></span><br><span class="line">        cmd.append(<span class="string">"  --margin-top 0 "</span>);</span><br><span class="line">        cmd.append(<span class="string">"  --margin-bottom 0 "</span>);</span><br><span class="line">        cmd.append(<span class="string">"  --margin-left 0 "</span>);</span><br><span class="line">        cmd.append(<span class="string">"  --margin-right 0 "</span>);</span><br><span class="line"><span class="comment">//        cmd.append(" page background, #D48F44 ");</span></span><br><span class="line"><span class="comment">//        cmd.append(" --header-spacing 10 ");//    (设置页眉s和内容的距离,默认0)</span></span><br><span class="line">        cmd.append(srcPath);</span><br><span class="line">        cmd.append(<span class="string">" "</span>);</span><br><span class="line">        cmd.append(destPath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Process proc = Runtime.getRuntime().exec(cmd.toString());</span><br><span class="line">            HtmlToPdfInterceptor error = <span class="keyword">new</span> HtmlToPdfInterceptor(proc.getErrorStream());</span><br><span class="line">            HtmlToPdfInterceptor output = <span class="keyword">new</span> HtmlToPdfInterceptor(proc.getInputStream());</span><br><span class="line">            error.start();</span><br><span class="line">            output.start();</span><br><span class="line">            proc.waitFor();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            result = <span class="keyword">false</span>;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Html2Pdf.convert(<span class="string">"e:/123.html"</span>, <span class="string">"e:/wkhtmltopdf_535.pdf"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>用这种方式进行转换相对简单方便，但是会存在个小问题，就是你在 html 中指定了大小之后，转完 pdf 不一定会完全一样，存在些误差，需要自己在做下调整。但相对 <code>itext</code> 要舒服的多，毕竟借用了三方插件。</p>
<ul>
<li>最后 附上 <code>itext</code> 实现传换的代码和 wkhtmltopdf 参数详解<br><code>itext</code> demo：<br>1、 引入依赖<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itextpdf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>itextpdf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.5.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itextpdf.tool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xmlworker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.5.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>2、demo<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"> <span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">import</span> com.itextpdf.text.Document;</span><br><span class="line"> <span class="keyword">import</span> com.itextpdf.text.PageSize;</span><br><span class="line"> <span class="keyword">import</span> com.itextpdf.text.pdf.PdfWriter;</span><br><span class="line"> <span class="keyword">import</span> com.itextpdf.tool.xml.XMLWorkerHelper;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> hanfeng on 2018-4-16.</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@version</span> 4.0</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HtmlToPDF</span> </span>&#123;</span><br><span class="line">   <span class="comment">// html 模板路径</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HTML = <span class="string">"D:/123.htm"</span>;</span><br><span class="line">     <span class="comment">// pdf 保存路径</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PDF = <span class="string">"D:/123.htm"</span>;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 测试</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 1</span></span><br><span class="line">       Document document = <span class="keyword">new</span> Document();</span><br><span class="line">       <span class="comment">// 2</span></span><br><span class="line">       PdfWriter writer = PdfWriter.getInstance(document, newFileOutputStream(PDF));</span><br><span class="line">       <span class="comment">// 3</span></span><br><span class="line">       document.open();</span><br><span class="line">       <span class="comment">// 4</span></span><br><span class="line">       XMLWorkerHelper.getInstance().parseXHtml(writer, document,<span class="keyword">new</span> FileInputStream(HTML));</span><br><span class="line">       <span class="comment">// 5</span></span><br><span class="line">        document.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>wkhtmltopdf 参数详解 ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">wkhtmltopdf [OPTIONS]... &lt;input file&gt; [More input files] &lt;output file&gt;</span><br><span class="line">常规选项</span><br><span class="line">     --allow &lt;path&gt;  允许加载从指定的文件夹中的文件或文件（可重复）</span><br><span class="line">    --book*  设置一会打印一本书的时候，通常设置的选项 </span><br><span class="line">     --collate  打印多份副本时整理 </span><br><span class="line">     --cookie &lt;name&gt; &lt;value&gt;  设置一个额外的cookie（可重复） </span><br><span class="line">     --cookie-jar &lt;path&gt;  读取和写入的Cookie，并在提供的cookie jar文件 </span><br><span class="line">     --copies &lt;number&gt;  复印打印成pdf文件数（默认为1） </span><br><span class="line">     --cover* &lt;url&gt;  使用HTML文件作为封面。它会带页眉和页脚的TOC之前插入 </span><br><span class="line">     --custom-header &lt;name&gt; &lt;value&gt;  设置一个附加的HTTP头（可重复） </span><br><span class="line">     --debug-javascript  显示的javascript调试输出 </span><br><span class="line">    --default-header*  添加一个缺省的头部，与页面的左边的名称，页面数到右边，例如： --header-left &apos;[webpage]&apos; --header-right &apos;[page]/[toPage]&apos;  --header-line </span><br><span class="line">     --disable-external-links*  禁止生成链接到远程网页</span><br><span class="line">     --disable-internal-links*  禁止使用本地链接</span><br><span class="line">    --disable-javascript  禁止让网页执行JavaScript </span><br><span class="line">     --disable-pdf-compression*  禁止在PDF对象使用无损压缩 </span><br><span class="line">     --disable-smart-shrinking*  禁止使用WebKit的智能战略收缩，使像素/ DPI比没有不变 </span><br><span class="line">     --disallow-local-file-access  禁止允许转换的本地文件读取其他本地文件，除非explecitily允许用 --allow </span><br><span class="line">    --dpi &lt;dpi&gt;  显式更改DPI（这对基于X11的系统没有任何影响） </span><br><span class="line">     --enable-plugins  启用已安装的插件（如Flash</span><br><span class="line">     --encoding &lt;encoding&gt;  设置默认的文字编码 </span><br><span class="line">     --extended-help  显示更广泛的帮助，详细介绍了不常见的命令开关 </span><br><span class="line">     --forms*  打开HTML表单字段转换为PDF表单域 </span><br><span class="line">    --grayscale  PDF格式将在灰阶产生</span><br><span class="line">    --help  Display help </span><br><span class="line">     --htmldoc  输出程序HTML帮助</span><br><span class="line">     --ignore-load-errors  忽略claimes加载过程中已经遇到了一个错误页面 </span><br><span class="line">    --lowquality  产生低品质的PDF/ PS。有用缩小结果文档的空间 </span><br><span class="line">     --manpage  输出程序手册页 </span><br><span class="line">    --margin-bottom &lt;unitreal&gt;  设置页面下边距 (default 10mm) </span><br><span class="line">    --margin-left &lt;unitreal&gt;  将左边页边距 (default 10mm) </span><br><span class="line">    --margin-right &lt;unitreal&gt;  设置页面右边距 (default 10mm) </span><br><span class="line">    --margin-top &lt;unitreal&gt;  设置页面上边距 (default 10mm) </span><br><span class="line">     --minimum-font-size &lt;int&gt;  最小字体大小 (default 5) </span><br><span class="line">     --no-background  不打印背景</span><br><span class="line">    --orientation &lt;orientation&gt;  设置方向为横向或纵向 </span><br><span class="line">     --page-height &lt;unitreal&gt;  页面高度 (default unit millimeter) </span><br><span class="line">     --page-offset* &lt;offset&gt;  设置起始页码 (default 1) </span><br><span class="line">    --page-size &lt;size&gt;  设置纸张大小: A4, Letter, etc. </span><br><span class="line">    --page-width &lt;unitreal&gt;  页面宽度 (default unit millimeter) </span><br><span class="line">     --password &lt;password&gt;  HTTP验证密码 </span><br><span class="line">     --post &lt;name&gt; &lt;value&gt;  Add an additional post field (repeatable) </span><br><span class="line">     --post-file &lt;name&gt; &lt;path&gt;  Post an aditional file (repeatable) </span><br><span class="line">     --print-media-type*  使用的打印介质类型，而不是屏幕 </span><br><span class="line">    --proxy &lt;proxy&gt;  使用代理 </span><br><span class="line">    --quiet  Be less verbose </span><br><span class="line">    --read-args-from-stdin  读取标准输入的命令行参数 </span><br><span class="line">    --readme  输出程序自述</span><br><span class="line">    --redirect-delay &lt;msec&gt;  等待几毫秒为JS-重定向(default 200) </span><br><span class="line">    --replace* &lt;name&gt; &lt;value&gt;  替换名称,值的页眉和页脚（可重复） </span><br><span class="line">    --stop-slow-scripts  停止运行缓慢的JavaScripts </span><br><span class="line">    --title &lt;text&gt;  生成的PDF文件的标题（第一个文档的标题使用，如果没有指定） </span><br><span class="line">    --toc*  插入的内容的表中的文件的开头</span><br><span class="line">    --use-xserver*  使用X服务器（一些插件和其他的东西没有X11可能无法正常工作） </span><br><span class="line">    --user-style-sheet &lt;url&gt;  指定用户的样式表，加载在每一页中</span><br><span class="line">    --username &lt;username&gt;  HTTP认证的用户名 </span><br><span class="line">    --version  输出版本信息退出</span><br><span class="line">     --zoom &lt;float&gt;  使用这个缩放因子 (default 1) </span><br><span class="line"></span><br><span class="line">页眉和页脚选项</span><br><span class="line">--header-center*    &lt;text&gt;    (设置在中心位置的页眉内容)  </span><br><span class="line">--header-font-name* &lt;name&gt;    (default Arial)  (设置页眉的字体名称)</span><br><span class="line">--header-font-size* &lt;size&gt;    (设置页眉的字体大小)</span><br><span class="line">--header-html*  &lt;url&gt; (添加一个HTML页眉,后面是网址)</span><br><span class="line">--header-left*  &lt;text&gt;   (左对齐的页眉文本)</span><br><span class="line">--header-line*      (显示一条线在页眉下)</span><br><span class="line">--header-right* &lt;text&gt;    (右对齐页眉文本)</span><br><span class="line">--header-spacing*   &lt;real&gt;    (设置页眉和内容的距离,默认0)</span><br><span class="line">--footer-center*    &lt;text&gt;    (设置在中心位置的页脚内容)  </span><br><span class="line">--footer-font-name* &lt;name&gt;    (设置页脚的字体名称) </span><br><span class="line">--footer-font-size* &lt;size&gt;    (设置页脚的字体大小default 11)</span><br><span class="line">--footer-html*  &lt;url&gt; (添加一个HTML页脚,后面是网址)</span><br><span class="line">--footer-left*  &lt;text&gt;    (左对齐的页脚文本)</span><br><span class="line">--footer-line*      显示一条线在页脚内容上)</span><br><span class="line">--footer-right* &lt;text&gt;    (右对齐页脚文本)</span><br><span class="line">--footer-spacing*   &lt;real&gt;    (设置页脚和内容的距离)</span><br><span class="line">./wkhtmltopdf --footer-right &apos;[page]/[topage]&apos; http://www.baidu.com baidu.pdf</span><br><span class="line">./wkhtmltopdf --header-center &apos;报表&apos; --header-line --margin-top 2cm --header-line http://192.168.212.139/oma/  oma.pdf</span><br><span class="line">表内容选项中</span><br><span class="line"> --toc-depth* &lt;level&gt;  Set the depth of the toc (default 3) </span><br><span class="line"> --toc-disable-back-links*  Do not link from section header to toc </span><br><span class="line"> --toc-disable-links*  Do not link from toc to sections </span><br><span class="line"> --toc-font-name* &lt;name&gt;  Set the font used for the toc (default Arial) </span><br><span class="line"> --toc-header-font-name* &lt;name&gt;  The font of the toc header (if unset use --toc-font-name) </span><br><span class="line"> --toc-header-font-size* &lt;size&gt;  The font size of the toc header (default 15) </span><br><span class="line"> --toc-header-text* &lt;text&gt;  The header text of the toc (default Table Of Contents) </span><br><span class="line"> --toc-l1-font-size* &lt;size&gt;  Set the font size on level 1 of the toc (default 12) </span><br><span class="line"> --toc-l1-indentation* &lt;num&gt;  Set indentation on level 1 of the toc (default 0) </span><br><span class="line"> --toc-l2-font-size* &lt;size&gt;  Set the font size on level 2 of the toc (default 10) </span><br><span class="line"> --toc-l2-indentation* &lt;num&gt;  Set indentation on level 2 of the toc (default 20) </span><br><span class="line"> --toc-l3-font-size* &lt;size&gt;  Set the font size on level 3 of the toc (default 8) </span><br><span class="line"> --toc-l3-indentation* &lt;num&gt;  Set indentation on level 3 of the toc (default 40) </span><br><span class="line"> --toc-l4-font-size* &lt;size&gt;  Set the font size on level 4 of the toc (default 6) </span><br><span class="line"> --toc-l4-indentation* &lt;num&gt;  Set indentation on level 4 of the toc (default 60) </span><br><span class="line"> --toc-l5-font-size* &lt;size&gt;  Set the font size on level 5 of the toc (default 4) </span><br><span class="line"> --toc-l5-indentation* &lt;num&gt;  Set indentation on level 5 of the toc (default 80) </span><br><span class="line"> --toc-l6-font-size* &lt;size&gt;  Set the font size on level 6 of the toc (default 2) </span><br><span class="line"> --toc-l6-indentation* &lt;num&gt;  Set indentation on level 6 of the toc (default 100) </span><br><span class="line"> --toc-l7-font-size* &lt;size&gt;  Set the font size on level 7 of the toc (default 0) </span><br><span class="line"> --toc-l7-indentation* &lt;num&gt;  Set indentation on level 7 of the toc (default 120) </span><br><span class="line"> --toc-no-dots*  Do not use dots, in the toc</span><br><span class="line">轮廓选项</span><br><span class="line"> --dump-outline &lt;file&gt;  转储目录到一个文件</span><br><span class="line"> --outline  显示目录(文章中h1,h2来定)</span><br><span class="line"> --outline-depth &lt;level&gt;  设置目录的深度（默认为4）</span><br><span class="line">页脚和页眉</span><br><span class="line"> * [page]       由当前正在打印的页的数目代替</span><br><span class="line"> * [frompage]   由要打印的第一页的数量取代</span><br><span class="line"> * [topage]     由最后一页要打印的数量取代</span><br><span class="line"> * [webpage]    通过正在打印的页面的URL替换</span><br><span class="line"> * [section]    由当前节的名称替换</span><br><span class="line"> * [subsection] 由当前小节的名称替换</span><br><span class="line"> * [date]       由当前日期系统的本地格式取代</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
        
<div class="counter-tag counter">
    <span id="/2018/04/17/html 转换成 pdf/" class="leancloud_visitors post-title-link" style="font-size: 12px" data-flag-title="html 转换成 pdf">
         &nbsp;
        view
    </span>
</div>

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>


 








  
    <article id="post-Spring AOP的实现原理" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/04/14/Spring AOP的实现原理/" class="article-date">
  	<time datetime="2018-04-13T16:00:00.000Z" itemprop="datePublished">2018-04-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/14/Spring AOP的实现原理/">
        Spring AOP的实现原理
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>原文出处： <a href="http://listenzhangbin.com/post/2016/09/spring-aop-cglib/" target="_blank" rel="noopener">Listen</a></p>
<p>AOP（Aspect Orient Programming），我们一般称为面向方面（切面）编程，作为面向对象的一种补充，用于处理系统中分布于各个模块的横切关注点，比如事务管理、日志、缓存等等。AOP 实现的关键在于AOP框架自动创建的 AOP 代理，AOP 代理主要分为静态代理和动态代理，静态代理的代表为 <code>AspectJ</code>；而动态代理则以 <code>Spring AOP</code> 为代表。本文会分别对 <code>AspectJ</code> 和  <code>Spring AOP</code> 的实现进行分析和介绍。</p>
<h2 id="一、使用-AspectJ-的编译时增强实现-AOP"><a href="#一、使用-AspectJ-的编译时增强实现-AOP" class="headerlink" title="一、使用 AspectJ 的编译时增强实现 AOP"></a>一、使用 AspectJ 的编译时增强实现 AOP</h2><p>之前提到，AspectJ 是静态代理的增强，所谓的静态代理就是 AOP 框架会在编译阶段生成 AOP 代理类，因此也称为编译时增强。</p>
<p>举个实例的例子来说。首先我们有一个普通的Hello类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Hello h = <span class="keyword">new</span> Hello();</span><br><span class="line">        h.sayHello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>AspectJ</code> 编写一个 Aspect<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> aspect TxAspect &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">around</span><span class="params">()</span>:<span class="title">call</span><span class="params">(<span class="keyword">void</span> Hello.sayHello()</span>)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始事务 ..."</span>);</span><br><span class="line">        proceed();</span><br><span class="line">        System.out.println(<span class="string">"事务结束 ..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里模拟了一个事务的场景，类似于 Spring 的声明式事务。使用 <code>AspectJ</code> 的编译器编译<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ajc -d . Hello.java TxAspect.aj</span><br></pre></td></tr></table></figure></p>
<p>编译完成之后再运行这个Hello类，可以看到以下输出</p>
<pre><code>开始事务 ...
hello
事务结束 ...
</code></pre><p>显然，AOP已经生效了，那么究竟 <code>AspectJ</code> 是如何在没有修改Hello类的情况下为Hello类增加新功能的呢？<br>查看一下编译后的 <code>Hello.class</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Hello h = <span class="keyword">new</span> Hello();</span><br><span class="line">        sayHello_aroundBody1$advice(h, TxAspect.aspectOf(), (AroundClosure)<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这个类比原来的 <code>Hello.java</code> 多了一些代码，这就是 <code>AspectJ</code> 的静态代理，它会在编译阶段将 <code>AspectJ</code> 织入 <code>Java</code> 字节码中， 运行的时候就是经过增强之后的 <code>AOP</code> 对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> ajc$around$com_listenzhangbin_aop_TxAspect$<span class="number">1</span>$f54fe983(AroundClosure ajc$aroundClosure) &#123;</span><br><span class="line">        System.out.println(<span class="string">"开始事务 ..."</span>);</span><br><span class="line">        ajc$around$com_listenzhangbin_aop_TxAspect$<span class="number">1</span>$f54fe983proceed(ajc$aroundClosure);</span><br><span class="line">        System.out.println(<span class="string">"事务结束 ..."</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>从 Aspect 编译后的 class 文件可以更明显的看出执行的逻辑。proceed 方法就是回调执行被代理类中的方法。</p>
<h2 id="二、使用Spring-AOP"><a href="#二、使用Spring-AOP" class="headerlink" title="二、使用Spring AOP"></a>二、使用Spring AOP</h2><p>与 <code>AspectJ</code> 的静态代理不同，<code>Spring AOP</code> 使用的动态代理，所谓的动态代理就是说AOP框架不会去修改字节码，而是在内存中临时为方法生成一个 AOP 对象，这个 AOP 对象包含了目标对象的全部方法，并且在特定的切点做了增强处理，并回调原对象的方法。</p>
<p><code>Spring AOP</code> 中的动态代理主要有两种方式，JDK 动态代理和 CGLIB 动态代理。JDK 动态代理通过反射来接收被代理的类，并且要求被代理的类必须实现一个接口。JDK 动态代理的核心是 <code>InvocationHandler</code> 接口和 <code>Proxy</code> 类。</p>
<p>如果目标类没有实现接口，那么 <code>Spring AOP</code> 会选择使用CGLIB来动态代理目标类。CGLIB（Code Generation Library），是一个代码生成的类库，可以在运行时动态的生成某个类的子类，注意，CGLIB是通过继承的方式做的动态代理，因此如果某个类被标记为 final，那么它是无法使用 CGLIB 做动态代理的。</p>
<p>为了验证以上的说法，可以做一个简单的测试。首先测试实现接口的情况。</p>
<p>定义一个接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实现类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Chinese</span> <span class="keyword">implements</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Timer</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"-- sayHello() --"</span>);</span><br><span class="line">        <span class="keyword">return</span> name + <span class="string">" hello, AOP"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(String food)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"我正在吃："</span> + food);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 <code>@Timer</code> 注解是我自己定义的一个普通注解，用来标记 Pointcut。</p>
<p>定义Aspect<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdviceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.listenzhangbin.aop.Timer)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"pointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootDemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里必须使用Person接口做注入</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Person chinese;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        chinese.sayHello(<span class="string">"listen"</span>);</span><br><span class="line">        System.out.println(chinese.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBootDemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">before</span><br><span class="line">-- sayHello() --</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">sun</span>.<span class="title">proxy</span>.$<span class="title">Proxy53</span></span></span><br></pre></td></tr></table></figure></p>
<p>可以看到类型是 com.sun.proxy.$Proxy53，也就是前面提到的 Proxy 类，因此这里 Spring AOP 使用了 JDK 的动态代理。</p>
<p>再来看看不实现接口的情况，修改 Chinese 类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Chinese</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Timer</span></span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"-- sayHello() --"</span>);</span><br><span class="line">        <span class="keyword">return</span> name + <span class="string">" hello, AOP"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(String food)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"我正在吃："</span> + food);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootDemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//直接用Chinese类注入</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Chinese chinese;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        chinese.sayHello(<span class="string">"listen"</span>);</span><br><span class="line">        System.out.println(chinese.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBootDemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">before</span><br><span class="line">-- sayHello() --</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">listenzhangbin</span>.<span class="title">aop</span>.<span class="title">Chinese</span>$$<span class="title">EnhancerBySpringCGLIB</span>$$56<span class="title">b89168</span></span></span><br></pre></td></tr></table></figure></p>
<p>可以看到类被 CGLIB 增强了，也就是动态代理。这里的 CGLIB 代理就是 Spring AOP 的代理，这个类也就是所谓的 AOP 代理，AOP 代理类在切点动态地织入了增强处理。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>AspectJ 在编译时就增强了目标对象，Spring AOP 的动态代理则是在每次运行时动态的增强，生成 AOP 代理对象，区别在于生成 AOP 代理对象的时机不同，相对来说 AspectJ 的静态代理方式具有更好的性能，但是 AspectJ 需要特定的编译器进行处理，而 Spring AOP 则无需特定的编译器处理。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
        
<div class="counter-tag counter">
    <span id="/2018/04/14/Spring AOP的实现原理/" class="leancloud_visitors post-title-link" style="font-size: 12px" data-flag-title="Spring AOP的实现原理">
         &nbsp;
        view
    </span>
</div>

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>


 








  
    <article id="post-spring boot+AOP+自定义注解记录日志" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/04/03/spring boot+AOP+自定义注解记录日志/" class="article-date">
  	<time datetime="2018-04-02T16:00:00.000Z" itemprop="datePublished">2018-04-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/03/spring boot+AOP+自定义注解记录日志/">
        spring boot+AOP+自定义注解记录日志
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>java 在 jdk1.5 中引入了注解，spring 框架也正好把 java 注解发挥得淋漓尽致。<br>下面会讲解 Spring 中自定义注解的简单流程。</p>
<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>引入 maven 依赖:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="一、自定义注解"><a href="#一、自定义注解" class="headerlink" title="一、自定义注解"></a>一、自定义注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义 操作记录 注解</span></span><br><span class="line"><span class="comment"> * 增加操作记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hanfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.PARAMETER, ElementType.METHOD&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ActionRecord &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义参数</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    String parma;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义参数 可以设置默认值</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    String parma <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，一个自定义注解就已经定义结束，当然你也可以加上一些约束，比如只能加在类上，方法上等，这里不做举例。</p>
<h2 id="二、解析注解"><a href="#二、解析注解" class="headerlink" title="二、解析注解"></a>二、解析注解</h2><p>此处使用了spring 的 AOP（面向切面编程）特性,通过 <code>@Aspect</code> 注解使该类成为切面类,通过 <code>@Pointcut</code> 指定切入点 ，这里指定的切入点为 ActionRecord 注解类型，也就是被 <code>@ActionRecord</code> 注解修饰的方法，进入该切入点。</p>
<p>注解简述：</p>
<ul>
<li>@Before 前置通知：在某连接点之前执行的通知，但这个通知不能阻止连接点之前的执行流程（除非它抛出一个异常）。</li>
<li>@Around 环绕通知：可以实现方法执行前后操作，需要在方法内执行point.proceed(); 并返回结果。</li>
<li>@AfterReturning 后置通知：在某连接点正常完成后执行的通知：例如，一个方法没有抛出任何异常，正常返回。</li>
<li>@AfterThrowing 异常通知：在方法抛出异常退出时执行的通知。</li>
<li>@After 后置通知：在某连接点正常完成后执行的通知：例如，一个方法没有抛出任何异常，正常返回。</li>
<li><p>切入点参数说明：<br>  controllerAspect: 指定要扫描的包。<br>  @Pointcut中符号的解释：</p>
<pre><code>第一个 * 代表任意修饰符及任意返回值. 
第二个 * 任意包名 
第三个 * 代表任意方法. 
第四个 * 定义在web包或者子包 
第五个 * 任意方法 
.. 匹配任意数量的参数.
</code></pre></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.thunisoft.dzjz.commons.utils.UUIDUtils;</span><br><span class="line"><span class="keyword">import</span> com.thunisoft.dzjz.model.CzrzEntity;</span><br><span class="line"><span class="keyword">import</span> com.thunisoft.dzjz.service.CzrzService;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> javassist.bytecode.CodeAttribute;</span><br><span class="line"><span class="keyword">import</span> javassist.bytecode.LocalVariableAttribute;</span><br><span class="line"><span class="keyword">import</span> javassist.bytecode.MethodInfo;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.Signature;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ObjectUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 操作记录aop</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hanfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 4.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CzrzAopAction</span> </span>&#123;</span><br><span class="line">    <span class="comment">//保证并发下 数据的纯洁</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;MetaData&gt; metaDataContainer = ThreadLocal.withInitial(MetaData::<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取开始时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> BEGIN_TIME;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取结束时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> END_TIME;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取监控的方法名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String METHOD_NAME;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义本次log实体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;CzrzEntity&gt; czrzEntities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 切入点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(* com.thunisoft.dzjz.server.controller..*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">controllerAspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前置通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"controllerAspect()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doBefore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BEGIN_TIME = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 后置通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"controllerAspect()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        END_TIME = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(METHOD_NAME)) &#123;</span><br><span class="line">            log.debug(<span class="string">"方法：【"</span> + METHOD_NAME + <span class="string">"】运行时间为："</span> + (END_TIME - BEGIN_TIME));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法结束执行后的操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AfterReturning</span>(returning = <span class="string">"object"</span>, pointcut = <span class="string">"controllerAspect()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfter</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//因为我的接口都是 RESTful 风格的  所以我才这么梳理  最终的验证视业务而定</span></span><br><span class="line">            ResponseEntity responseEntity = (ResponseEntity) object;</span><br><span class="line">            <span class="keyword">if</span> (responseEntity.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">                <span class="comment">//保存记录  数据入库  不想用异步线程的  直接插入  保存方式视情况选择吧</span></span><br><span class="line">                CzrzRunner czrzRunner = <span class="keyword">new</span> CzrzRunner(czrzEntities, czrzService);</span><br><span class="line">                czrzRunner.run();</span><br><span class="line">                <span class="keyword">for</span> (CzrzEntity czrzEntity : czrzEntities) &#123;</span><br><span class="line">                    czrzService.addCzrz(czrzEntity);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">"当前方法执行结束后拦截不到操作状态"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法有异常时的操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(<span class="string">"controllerAspect()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterThrow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.error(<span class="string">"增加操作记录异常"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 环绕通知</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pjp 切片连接点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"controllerAspect()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(JoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">//自定义的当前线程的全局信息  可有可无 视业务增加</span></span><br><span class="line">        MetaData metaData = CzrzAopAction.metaDataContainer.get();</span><br><span class="line">        <span class="comment">//获取被拦截的方法</span></span><br><span class="line">        Method method = getActionRecordMethod(metaData, pjp);</span><br><span class="line">        <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//log.info(……)；</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取注解信息</span></span><br><span class="line">        ActionRecord actionRecord = method.getAnnotation(ActionRecord.class);</span><br><span class="line">        <span class="keyword">if</span> (actionRecord == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//log.info(……)；</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 默认不需要记录操作日志，如果有 ActionRecord 注解，说明需要记录日志</span></span><br><span class="line">        metaData.setNeedRecord(<span class="keyword">true</span>);</span><br><span class="line">        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">        metaData.fillReqInfo(request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取请求中的参数 这里面包含了controller不需要的参数，需单独处理</span></span><br><span class="line">        String queryString = request.getQueryString();</span><br><span class="line">        <span class="comment">//获取controller参数</span></span><br><span class="line">        Map&lt;String, String[]&gt; queryMap = dealQueryData(pjp, queryString);</span><br><span class="line">        <span class="comment">//获取参数键值对</span></span><br><span class="line">        Map&lt;String, String[]&gt; queryRequestMap = request.getParameterMap();</span><br><span class="line">        <span class="comment">//做去重处理  兼容各种参数形式</span></span><br><span class="line">        queryMap.putAll(queryRequestMap);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *说明 ：上面为什么样这么获取参数，是因为单存的用一种不能拦截到所有情况的参数。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**开始组装 日志实体信息   dosomeThing  这里不举例了</span></span><br><span class="line"><span class="comment">         * 操作记录模板需要定制化的 要自己来实现模板数据的解析</span></span><br><span class="line"><span class="comment">         * 如果 不同的功能记录不同的信息模板  则可以用下面的方式  否则只需要一条就ok</span></span><br><span class="line"><span class="comment">         * 条件视业务定  如果定义了  metaData 需要将结果放入其中  如果没有  直接做入库操作即可</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">switch</span> (actionRecord.operation()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">               dosomeThingToBuildczrzEntities；</span><br><span class="line">                metaData.czrzEntities.add(czrzEntity);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                dosomeThingToBuildczrzEntities；</span><br><span class="line">                metaData.czrzEntities.add(czrzEntity);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">               dosomeThingToBuildczrzEntities；</span><br><span class="line">               metaData.czrzEntities.add(czrzEntity);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The type Meta data.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaData</span> </span>&#123;……&#125;</span><br></pre></td></tr></table></figure>
<p>上面方法：<code>getActionRecordMethod</code> 的实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取监控的方法</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> metaData</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> pjp 切片点</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 方法</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> Method <span class="title">getActionRecordMethod</span><span class="params">(MetaData metaData, JoinPoint pjp)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 拦截的方法名称。当前正在执行的方法</span></span><br><span class="line">       Signature sig = pjp.getSignature();</span><br><span class="line">       metaData.setMethodName(sig.getName());</span><br><span class="line">       <span class="comment">// 拦截的放参数类型</span></span><br><span class="line">       <span class="keyword">if</span> (!(sig <span class="keyword">instanceof</span> MethodSignature)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException(<span class="string">"添加操作记录失败。原因：@ActionRecord 该注解只能用于方法"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       MethodSignature msig = (MethodSignature) sig;</span><br><span class="line">       Class[] parameterTypes = msig.getMethod().getParameterTypes();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> pjp.getTarget().getClass().getMethod(sig.getName(), parameterTypes);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">           log.warn(<span class="string">"添加操作记录失败。原因：增加操作记录，监控方法时出现异常，方法名称：&#123;&#125;"</span>, sig.getName(), e);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>上面方法： <code>dealQueryData</code> 的实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理拦截导弹参数和参数名称</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pjp         切片连接点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queryString requset请求中参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 参数键值对</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception 异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, String[]&gt; dealQueryData(JoinPoint pjp, String queryString) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//获取请求方法中的参数名称</span></span><br><span class="line">    String[] paramName = getFieldsName(pjp.getTarget().getClass().getName(), metaDataContainer.get().getMethodName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拦截的controller方法参数值</span></span><br><span class="line">    Object[] args = pjp.getArgs();</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtils.isEmpty(paramName) || args.length != paramName.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    String paramterConnector = <span class="string">"&amp;"</span>;</span><br><span class="line">    String paramterAssignment = <span class="string">"="</span>;</span><br><span class="line">    Map&lt;String, String[]&gt; resultMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(queryString)) &#123;</span><br><span class="line">        <span class="comment">//这里获取到的结构是 key=value 的格式</span></span><br><span class="line">        String[] queryKeyAndValue = queryString.split(paramterConnector);</span><br><span class="line">        <span class="keyword">for</span> (String parameter : queryKeyAndValue) &#123;</span><br><span class="line">            <span class="comment">//这里获取到的结构是 key &amp; value 的值</span></span><br><span class="line">            String[] queryValue = parameter.split(paramterAssignment);</span><br><span class="line">            <span class="keyword">if</span> (resultMap.containsKey(queryValue[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            resultMap.put(queryValue[<span class="number">0</span>], <span class="keyword">new</span> String[] &#123; queryValue[<span class="number">1</span>] &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paramName.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (resultMap.containsKey(paramName[i])) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//做下特殊处理，有的解析后是个数组兼容下  可以视自己的业务来处理解析结果</span></span><br><span class="line">        <span class="keyword">if</span> (args[i] <span class="keyword">instanceof</span> String[]) &#123;</span><br><span class="line">            resultMap.put(paramName[i], (String[]) args[i]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args[i] <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            resultMap.put(paramName[i], <span class="keyword">new</span> String[] &#123; args[i].toString() &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(ObjectUtils.isEmpty(args[i]))&#123;</span><br><span class="line">            resultMap.put(paramName[i],<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Object obj = args[i];</span><br><span class="line">            BeanInfo beanInfo = Introspector.getBeanInfo(obj.getClass());</span><br><span class="line">            PropertyDescriptor[] propertyDescriptors = beanInfo.getPropertyDescriptors();</span><br><span class="line">            <span class="keyword">for</span> (PropertyDescriptor property : propertyDescriptors) &#123;</span><br><span class="line">                String key = property.getName();</span><br><span class="line">                <span class="keyword">if</span> (key.compareToIgnoreCase(<span class="string">"class"</span>) == <span class="number">0</span> || key.compareToIgnoreCase(<span class="string">"writer"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Method getter = property.getReadMethod();</span><br><span class="line">                Object value = getter != <span class="keyword">null</span> ? getter.invoke(obj) : <span class="keyword">null</span>;</span><br><span class="line">                String objV = ObjectUtils.isEmpty(value) ? <span class="string">""</span> : value.toString();</span><br><span class="line">                resultMap.put(key, <span class="keyword">new</span> String[] &#123; objV &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法：<code>getFieldsName</code> 的实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 使用javassist来获取方法参数名称</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> className  类名</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> methodName 方法名</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 名字集合</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception 异常</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> String[] getFieldsName(String className, String methodName) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">       String clazzName = clazz.getName();</span><br><span class="line">       ClassPool pool = ClassPool.getDefault();</span><br><span class="line">       ClassClassPath classPath = <span class="keyword">new</span> ClassClassPath(clazz);</span><br><span class="line">       pool.insertClassPath(classPath);</span><br><span class="line"></span><br><span class="line">       CtClass ctClass = pool.get(clazzName);</span><br><span class="line">       CtMethod ctMethod = ctClass.getDeclaredMethod(methodName);</span><br><span class="line">       MethodInfo methodInfo = ctMethod.getMethodInfo();</span><br><span class="line">       CodeAttribute codeAttribute = methodInfo.getCodeAttribute();</span><br><span class="line">       LocalVariableAttribute attr = (LocalVariableAttribute) codeAttribute.getAttribute(LocalVariableAttribute.tag);</span><br><span class="line">       <span class="keyword">if</span> (attr == <span class="keyword">null</span>) &#123;</span><br><span class="line">           String message = <span class="string">"添加操作记录失败。原因：拦截请求：【"</span> + metaDataContainer.get().getMethodName() + <span class="string">" 】的方法中的参数名称失败"</span>;</span><br><span class="line">           log.warn(message);</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException(message);</span><br><span class="line">       &#125;</span><br><span class="line">       String[] paramsArgsName = <span class="keyword">new</span> String[ctMethod.getParameterTypes().length];</span><br><span class="line">       <span class="keyword">int</span> pos = Modifier.isStatic(ctMethod.getModifiers()) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paramsArgsName.length; i++) &#123;</span><br><span class="line">           paramsArgsName[i] = attr.variableName(i + pos);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (ObjectUtils.isEmpty(paramsArgsName)) &#123;</span><br><span class="line">           String message = <span class="string">"添加操作记录失败。原因：拦截请求：【"</span> + metaDataContainer.get().getMethodName() + <span class="string">" 】的方法中的参数名称失败"</span>;</span><br><span class="line">           log.warn(message);</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException(message);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> paramsArgsName;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>小编认为，如果没有特殊 <code>@Before</code>、<code>@Around</code>、<code>@AfterReturning</code>、<code>@AfterThrowing</code>、<code>@After</code> 这些功能只需要保留 <code>@Before</code>、<code>@AfterReturning</code>、<code>@AfterThrowing</code> 这三个就可以慢足需求，<br>在<code>@Before</code> 中组装信息，<br>在 <code>@AfterReturning</code> 来确认数据是否需要保留，<br>在 <code>@AfterThrowing</code> 来处理异常情况。<br> 使用 AOP 还是很方便的。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
        
<div class="counter-tag counter">
    <span id="/2018/04/03/spring boot+AOP+自定义注解记录日志/" class="leancloud_visitors post-title-link" style="font-size: 12px" data-flag-title="spring boot+AOP+自定义注解记录日志">
         &nbsp;
        view
    </span>
</div>

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>


 








  
    <article id="post-使用Thymeleaf API渲染模板生成静态页面" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/03/17/使用Thymeleaf API渲染模板生成静态页面/" class="article-date">
  	<time datetime="2018-03-16T16:00:00.000Z" itemprop="datePublished">2018-03-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/17/使用Thymeleaf API渲染模板生成静态页面/">
        Thymeleaf API渲染模板
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="使用Thymeleaf-API渲染模板生成静态页面"><a href="#使用Thymeleaf-API渲染模板生成静态页面" class="headerlink" title="使用Thymeleaf API渲染模板生成静态页面"></a>使用Thymeleaf API渲染模板生成静态页面</h1><p>标签（空格分隔）： Thymeleaf  静态页面</p>
<hr>
<p>Thymeleaf 是新一代的Java模板引擎，它的语法对前端开发者友好可直接打开编辑，Spring Boot也建议使用它作为你的模板引擎，本文将演示如何使用它提供的API来渲染模板生成静态页面。</p>
<h2 id="一、引入maven依赖"><a href="#一、引入maven依赖" class="headerlink" title="一、引入maven依赖"></a>一、引入maven依赖</h2><p>spring boot中引用:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p> 或者：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="二、Java后台转换代码"><a href="#二、Java后台转换代码" class="headerlink" title="二、Java后台转换代码"></a>二、Java后台转换代码</h2><ul>
<li>1、准备静态模板 templates/example.html<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">"$&#123;name&#125;"</span>&gt;</span>列表名称<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">"item: $&#123;array&#125;"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;item&#125;"</span>&gt;</span>条目<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>2、获取静态资源 转换后 输出静态资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造模板引擎</span></span><br><span class="line">ClassLoaderTemplateResolver resolver = <span class="keyword">new</span> ClassLoaderTemplateResolver();</span><br><span class="line"><span class="comment">//模板所在目录，相对于当前classloader的classpath。模板的路径</span></span><br><span class="line">resolver.setPrefix(<span class="string">"templates/"</span>);</span><br><span class="line"><span class="comment">//模板文件后缀</span></span><br><span class="line">resolver.setSuffix(<span class="string">".html"</span>);</span><br><span class="line">TemplateEngine templateEngine = <span class="keyword">new</span> TemplateEngine();</span><br><span class="line">templateEngine.setTemplateResolver(resolver);</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造上下文(Model)</span></span><br><span class="line">Context context = <span class="keyword">new</span> Context();</span><br><span class="line">context.setVariable(<span class="string">"name"</span>, <span class="string">"蔬菜列表"</span>);</span><br><span class="line">context.setVariable(<span class="string">"array"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"土豆"</span>, <span class="string">"番茄"</span>, <span class="string">"白菜"</span>, <span class="string">"芹菜"</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//渲染模板 输出静态资源的位置</span></span><br><span class="line">FileWriter write = <span class="keyword">new</span> FileWriter(<span class="string">"result.html"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//进行解析组装数据</span></span><br><span class="line">templateEngine.process(<span class="string">"example"</span>, context, write);</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、结果</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>蔬菜列表<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>土豆<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>番茄<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>白菜<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>芹菜<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="三、直接返回属性值给前台页面，不需要后台转换"><a href="#三、直接返回属性值给前台页面，不需要后台转换" class="headerlink" title="三、直接返回属性值给前台页面，不需要后台转换"></a>三、直接返回属性值给前台页面，不需要后台转换</h2><ul>
<li><p>1、准备静态页面 index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">"$&#123;name&#125;"</span>&gt;</span>列表名称<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">"item: $&#123;array&#125;"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;item&#125;"</span>&gt;</span>条目<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>2、后台控制器返回数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThymeleafTestApplication</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(Model model)</span></span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"name"</span>,<span class="string">"蔬菜列表"</span>);</span><br><span class="line">        model.addAttribute(<span class="string">"array"</span>,<span class="keyword">new</span> String[]&#123;<span class="string">"土豆"</span>, <span class="string">"番茄"</span>, <span class="string">"白菜"</span>, <span class="string">"芹菜"</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ThymeleafTestApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、结果<br><img src="/img/thymeleaf_1.png" alt=""></p>
</li>
</ul>
<h2 id="四、错误解析"><a href="#四、错误解析" class="headerlink" title="四、错误解析"></a>四、错误解析</h2><p>如果报以下错误，是以为缺少 ognl.jar 包，使得解析器在处理html中的表达式时失败。</p>
<ul>
<li><p>1、异常信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NoClassDefFoundError: ognl/PropertyAccessor</span><br><span class="line"></span><br><span class="line">	at org.thymeleaf.standard.StandardDialect.getVariableExpressionEvaluator(StandardDialect.java:<span class="number">179</span>)</span><br><span class="line">	at org.thymeleaf.standard.StandardDialect.getExecutionAttributes(StandardDialect.java:<span class="number">393</span>)</span><br><span class="line">	at org.thymeleaf.DialectSetConfiguration.build(DialectSetConfiguration.java:<span class="number">263</span>)</span><br><span class="line">	at org.thymeleaf.EngineConfiguration.&lt;init&gt;(EngineConfiguration.java:<span class="number">123</span>)</span><br><span class="line">	at org.thymeleaf.TemplateEngine.initialize(TemplateEngine.java:<span class="number">336</span>)</span><br><span class="line">	at org.thymeleaf.TemplateEngine.process(TemplateEngine.java:<span class="number">1079</span>)</span><br><span class="line">	at org.thymeleaf.TemplateEngine.process(TemplateEngine.java:<span class="number">1067</span>)</span><br><span class="line">	at com.thunisoft.dzjz.conver.handle.impl.AbstractBuildCoverImpl.buildCover(AbstractBuildCoverImpl.java:<span class="number">92</span>)</span><br><span class="line">	at com.thunisoft.dzjz.conver.handle.IBuildCoverHandleTest.buildCover_volume(IBuildCoverHandleTest.java:<span class="number">73</span>)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.junit.runners.model.FrameworkMethod$<span class="number">1</span>.runReflectiveCall(FrameworkMethod.java:<span class="number">50</span>)</span><br><span class="line">	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:<span class="number">12</span>)</span><br><span class="line">	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:<span class="number">47</span>)</span><br><span class="line">	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:<span class="number">17</span>)</span><br><span class="line">	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:<span class="number">26</span>)</span><br><span class="line">	at org.springframework.test.context.junit4.statements.RunBeforeTestMethodCallbacks.evaluate(RunBeforeTestMethodCallbacks.java:<span class="number">75</span>)</span><br><span class="line">	at org.springframework.test.context.junit4.statements.RunAfterTestMethodCallbacks.evaluate(RunAfterTestMethodCallbacks.java:<span class="number">86</span>)</span><br><span class="line">	at org.springframework.test.context.junit4.statements.SpringRepeat.evaluate(SpringRepeat.java:<span class="number">84</span>)</span><br><span class="line">	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:<span class="number">325</span>)</span><br><span class="line">	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:<span class="number">252</span>)</span><br><span class="line">	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:<span class="number">94</span>)</span><br><span class="line">	at org.junit.runners.ParentRunner$<span class="number">3</span>.run(ParentRunner.java:<span class="number">290</span>)</span><br><span class="line">	at org.junit.runners.ParentRunner$<span class="number">1</span>.schedule(ParentRunner.java:<span class="number">71</span>)</span><br><span class="line">	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:<span class="number">288</span>)</span><br><span class="line">	at org.junit.runners.ParentRunner.access$<span class="number">000</span>(ParentRunner.java:<span class="number">58</span>)</span><br><span class="line">	at org.junit.runners.ParentRunner$<span class="number">2</span>.evaluate(ParentRunner.java:<span class="number">268</span>)</span><br><span class="line">	at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:<span class="number">61</span>)</span><br><span class="line">	at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:<span class="number">70</span>)</span><br><span class="line">	at org.junit.runners.ParentRunner.run(ParentRunner.java:<span class="number">363</span>)</span><br><span class="line">	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:<span class="number">191</span>)</span><br><span class="line">	at org.junit.runner.JUnitCore.run(JUnitCore.java:<span class="number">137</span>)</span><br><span class="line">	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:<span class="number">68</span>)</span><br><span class="line">	at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:<span class="number">47</span>)</span><br><span class="line">	at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:<span class="number">242</span>)</span><br><span class="line">	at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:<span class="number">70</span>)</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: ognl.PropertyAccessor</span><br><span class="line">	at java.net.URLClassLoader.findClass(URLClassLoader.java:<span class="number">381</span>)</span><br><span class="line">	at java.lang.ClassLoader.loadClass(ClassLoader.java:<span class="number">424</span>)</span><br><span class="line">	at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:<span class="number">331</span>)</span><br><span class="line">	at java.lang.ClassLoader.loadClass(ClassLoader.java:<span class="number">357</span>)</span><br><span class="line">	... <span class="number">38</span> more</span><br></pre></td></tr></table></figure>
</li>
<li><p>2、解决方法 pom 中引入 ognl.jar 即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ognl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ognl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
        
<div class="counter-tag counter">
    <span id="/2018/03/17/使用Thymeleaf API渲染模板生成静态页面/" class="leancloud_visitors post-title-link" style="font-size: 12px" data-flag-title="Thymeleaf API渲染模板">
         &nbsp;
        view
    </span>
</div>

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>


 








  
    <article id="post-SMB 协议的使用（原创）" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/01/21/SMB 协议的使用（原创）/" class="article-date">
  	<time datetime="2018-01-20T16:00:00.000Z" itemprop="datePublished">2018-01-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/21/SMB 协议的使用（原创）/">
        SMB 协议的使用（原创）
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1、什么是-SMB"><a href="#1、什么是-SMB" class="headerlink" title="1、什么是 SMB"></a>1、什么是 SMB</h2><p><a href="https://baike.baidu.com/item/SMB%E5%8D%8F%E8%AE%AE/3770892?fr=aladdin" target="_blank" rel="noopener">SMB</a>（Server Message Block）通信协议是微软（Microsoft）和英特尔(Intel)在1987年制定的协议，主要是作为Microsoft网络的通讯协议。SMB 是在会话层（session layer）和表示层（presentation layer）以及小部分应用层（application layer）的协议。</p>
<p>SMB使用了NetBIOS的应用程序接口 （Application Program Interface，简称API）。另外，它是一个开放性的协议，允许了协议扩展——使得它变得更大而且复杂；大约有65个最上层的作业，而每个作业都超过120个函数，甚至Windows NT也没有全部支持到，最近微软又把 SMB 改名为 CIFS（Common Internet File System），并且加入了许多新的特色。</p>
<h2 id="2、为什么使用-SMB-协议实现文件的读取"><a href="#2、为什么使用-SMB-协议实现文件的读取" class="headerlink" title="2、为什么使用 SMB 协议实现文件的读取"></a>2、为什么使用 SMB 协议实现文件的读取</h2><p>其实 SMB 协议使用非常简单，它方便了我们对共享文件（夹）的操作，我们不在需要知道具体的盘符，只要知道 IP（地址） PORT（端口） Folder（共享文件夹）即可。</p>
<h2 id="3、SMB协议的两种连接方式"><a href="#3、SMB协议的两种连接方式" class="headerlink" title="3、SMB协议的两种连接方式"></a>3、SMB协议的两种连接方式</h2><ul>
<li>1、访问和验证登录信息写在一起<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smb://&#123;user&#125;:&#123;password&#125;@&#123;host&#125;/&#123;path&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>参数说明：</p>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">user</td>
<td style="text-align:left">用户名（一般都是登录服务器所需的用户名）</td>
</tr>
<tr>
<td style="text-align:left">password</td>
<td style="text-align:left">密码（一般都是登录服务器所需的密码，和用户名配套）</td>
</tr>
<tr>
<td style="text-align:left">host</td>
<td style="text-align:left">服务器ip</td>
</tr>
<tr>
<td style="text-align:left">path</td>
<td style="text-align:left">要访问的资源名</td>
</tr>
</tbody>
</table>
<p>eg：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String url=&quot;smb://hanfeng:123@192.168.0.22/share&quot;;</span><br><span class="line">SmbFile smbFile = new SmbFile(url);</span><br></pre></td></tr></table></figure></p>
<p>注意：这种方式存在一个坑，当你的用户名或者密码中存在特殊字符时，解析会有问题，<br>比如像我们通用的密码会有个 @ 符号，但是在 SmbFile  解析时，这个 @ 符号后面跟的应该是 host，这样就导致他解析的结果和我们实际想要连接的不符。<br>那么它是怎们解析的url呢？<br>SmbFile 中包含的方法：</p>
<p><img src="/img/smb_1.png" alt="2"></p>
<p><img src="/img/smb_2.png" alt="3"></p>
<p><img src="/img/smb_3.png" alt="4"></p>
<p>SmbFile  我们所使用的构造器的源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SmbFile( String url ) throws MalformedURLException &#123;</span><br><span class="line">        this( new URL( null, url, Handler.SMB_HANDLER ));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>URL 源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">public URL(URL context, String spec, URLStreamHandler handler)</span><br><span class="line">        throws MalformedURLException</span><br><span class="line">    &#123;</span><br><span class="line">        String original = spec;</span><br><span class="line">        int i, limit, c;</span><br><span class="line">        int start = 0;</span><br><span class="line">        String newProtocol = null;</span><br><span class="line">        boolean aRef=false;</span><br><span class="line">        boolean isRelative = false;</span><br><span class="line"></span><br><span class="line">        // Check for permission to specify a handler</span><br><span class="line">        if (handler != null) &#123;</span><br><span class="line">            SecurityManager sm = System.getSecurityManager();</span><br><span class="line">            if (sm != null) &#123;</span><br><span class="line">                checkSpecifyHandler(sm);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            limit = spec.length();</span><br><span class="line">            while ((limit &gt; 0) &amp;&amp; (spec.charAt(limit - 1) &lt;= &apos; &apos;)) &#123;</span><br><span class="line">                limit--;        //eliminate trailing whitespace</span><br><span class="line">            &#125;</span><br><span class="line">            while ((start &lt; limit) &amp;&amp; (spec.charAt(start) &lt;= &apos; &apos;)) &#123;</span><br><span class="line">                start++;        // eliminate leading whitespace</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (spec.regionMatches(true, start, &quot;url:&quot;, 0, 4)) &#123;</span><br><span class="line">                start += 4;</span><br><span class="line">            &#125;</span><br><span class="line">            if (start &lt; spec.length() &amp;&amp; spec.charAt(start) == &apos;#&apos;) &#123;</span><br><span class="line">                /* we&apos;re assuming this is a ref relative to the context URL.</span><br><span class="line">                 * This means protocols cannot start w/ &apos;#&apos;, but we must parse</span><br><span class="line">                 * ref URL&apos;s like: &quot;hello:there&quot; w/ a &apos;:&apos; in them.</span><br><span class="line">                 */</span><br><span class="line">                aRef=true;</span><br><span class="line">            &#125;</span><br><span class="line">            for (i = start ; !aRef &amp;&amp; (i &lt; limit) &amp;&amp;</span><br><span class="line">                     ((c = spec.charAt(i)) != &apos;/&apos;) ; i++) &#123;</span><br><span class="line">                if (c == &apos;:&apos;) &#123;</span><br><span class="line"></span><br><span class="line">                    String s = spec.substring(start, i).toLowerCase();</span><br><span class="line">                    if (isValidProtocol(s)) &#123;</span><br><span class="line">                        newProtocol = s;</span><br><span class="line">                        start = i + 1;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Only use our context if the protocols match.</span><br><span class="line">            protocol = newProtocol;</span><br><span class="line">            if ((context != null) &amp;&amp; ((newProtocol == null) ||</span><br><span class="line">                            newProtocol.equalsIgnoreCase(context.protocol))) &#123;</span><br><span class="line">                // inherit the protocol handler from the context</span><br><span class="line">                // if not specified to the constructor</span><br><span class="line">                if (handler == null) &#123;</span><br><span class="line">                    handler = context.handler;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // If the context is a hierarchical URL scheme and the spec</span><br><span class="line">                // contains a matching scheme then maintain backwards</span><br><span class="line">                // compatibility and treat it as if the spec didn&apos;t contain</span><br><span class="line">                // the scheme; see 5.2.3 of RFC2396</span><br><span class="line">                if (context.path != null &amp;&amp; context.path.startsWith(&quot;/&quot;))</span><br><span class="line">                    newProtocol = null;</span><br><span class="line"></span><br><span class="line">                if (newProtocol == null) &#123;</span><br><span class="line">                    protocol = context.protocol;</span><br><span class="line">                    authority = context.authority;</span><br><span class="line">                    userInfo = context.userInfo;</span><br><span class="line">                    host = context.host;</span><br><span class="line">                    port = context.port;</span><br><span class="line">                    file = context.file;</span><br><span class="line">                    path = context.path;</span><br><span class="line">                    isRelative = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (protocol == null) &#123;</span><br><span class="line">                throw new MalformedURLException(&quot;no protocol: &quot;+original);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Get the protocol handler if not specified or the protocol</span><br><span class="line">            // of the context could not be used</span><br><span class="line">            if (handler == null &amp;&amp;</span><br><span class="line">                (handler = getURLStreamHandler(protocol)) == null) &#123;</span><br><span class="line">                throw new MalformedURLException(&quot;unknown protocol: &quot;+protocol);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            this.handler = handler;</span><br><span class="line"></span><br><span class="line">            i = spec.indexOf(&apos;#&apos;, start);</span><br><span class="line">            if (i &gt;= 0) &#123;</span><br><span class="line">                ref = spec.substring(i + 1, limit);</span><br><span class="line">                limit = i;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            /*</span><br><span class="line">             * Handle special case inheritance of query and fragment</span><br><span class="line">             * implied by RFC2396 section 5.2.2.</span><br><span class="line">             */</span><br><span class="line">            if (isRelative &amp;&amp; start == limit) &#123;</span><br><span class="line">                query = context.query;</span><br><span class="line">                if (ref == null) &#123;</span><br><span class="line">                    ref = context.ref;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            handler.parseURL(this, spec, start, limit);</span><br><span class="line"></span><br><span class="line">        &#125; catch(MalformedURLException e) &#123;</span><br><span class="line">            throw e;</span><br><span class="line">        &#125; catch(Exception e) &#123;</span><br><span class="line">            MalformedURLException exception = new MalformedURLException(e.getMessage());</span><br><span class="line">            exception.initCause(e);</span><br><span class="line">            throw exception;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>parseURL 源码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line">protected void parseURL(URL u, String spec, int start, int limit) &#123;</span><br><span class="line">        // These fields may receive context content if this was relative URL</span><br><span class="line">        String protocol = u.getProtocol();</span><br><span class="line">        String authority = u.getAuthority();</span><br><span class="line">        String userInfo = u.getUserInfo();</span><br><span class="line">        String host = u.getHost();</span><br><span class="line">        int port = u.getPort();</span><br><span class="line">        String path = u.getPath();</span><br><span class="line">        String query = u.getQuery();</span><br><span class="line"></span><br><span class="line">        // This field has already been parsed</span><br><span class="line">        String ref = u.getRef();</span><br><span class="line"></span><br><span class="line">        boolean isRelPath = false;</span><br><span class="line">        boolean queryOnly = false;</span><br><span class="line"></span><br><span class="line">// FIX: should not assume query if opaque</span><br><span class="line">        // Strip off the query part</span><br><span class="line">        if (start &lt; limit) &#123;</span><br><span class="line">            int queryStart = spec.indexOf(&apos;?&apos;);     // 这里——hf</span><br><span class="line">            queryOnly = queryStart == start;</span><br><span class="line">            if ((queryStart != -1) &amp;&amp; (queryStart &lt; limit)) &#123;</span><br><span class="line">                query = spec.substring(queryStart+1, limit);</span><br><span class="line">                if (limit &gt; queryStart)</span><br><span class="line">                    limit = queryStart;</span><br><span class="line">                spec = spec.substring(0, queryStart);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int i = 0;</span><br><span class="line">        // Parse the authority part if any</span><br><span class="line">        boolean isUNCName = (start &lt;= limit - 4) &amp;&amp;</span><br><span class="line">                        (spec.charAt(start) == &apos;/&apos;) &amp;&amp;</span><br><span class="line">                        (spec.charAt(start + 1) == &apos;/&apos;) &amp;&amp;</span><br><span class="line">                        (spec.charAt(start + 2) == &apos;/&apos;) &amp;&amp;</span><br><span class="line">                        (spec.charAt(start + 3) == &apos;/&apos;);   // 这里——hf</span><br><span class="line">        if (!isUNCName &amp;&amp; (start &lt;= limit - 2) &amp;&amp; (spec.charAt(start) == &apos;/&apos;) &amp;&amp;</span><br><span class="line">            (spec.charAt(start + 1) == &apos;/&apos;)) &#123;</span><br><span class="line">            start += 2;</span><br><span class="line">            i = spec.indexOf(&apos;/&apos;, start);</span><br><span class="line">            if (i &lt; 0) &#123;</span><br><span class="line">                i = spec.indexOf(&apos;?&apos;, start);</span><br><span class="line">                if (i &lt; 0)</span><br><span class="line">                    i = limit;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            host = authority = spec.substring(start, i);</span><br><span class="line"></span><br><span class="line">            int ind = authority.indexOf(&apos;@&apos;);  // 这里——hf</span><br><span class="line">            if (ind != -1) &#123;</span><br><span class="line">                userInfo = authority.substring(0, ind);</span><br><span class="line">                host = authority.substring(ind+1);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                userInfo = null;</span><br><span class="line">            &#125;</span><br><span class="line">            if (host != null) &#123;</span><br><span class="line">                // If the host is surrounded by [ and ] then its an IPv6</span><br><span class="line">                // literal address as specified in RFC2732</span><br><span class="line">                if (host.length()&gt;0 &amp;&amp; (host.charAt(0) == &apos;[&apos;)) &#123;</span><br><span class="line">                    if ((ind = host.indexOf(&apos;]&apos;)) &gt; 2) &#123;</span><br><span class="line"></span><br><span class="line">                        String nhost = host ;</span><br><span class="line">                        host = nhost.substring(0,ind+1);</span><br><span class="line">                        if (!IPAddressUtil.</span><br><span class="line">                            isIPv6LiteralAddress(host.substring(1, ind))) &#123;</span><br><span class="line">                            throw new IllegalArgumentException(</span><br><span class="line">                                &quot;Invalid host: &quot;+ host);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        port = -1 ;</span><br><span class="line">                        if (nhost.length() &gt; ind+1) &#123;</span><br><span class="line">                            if (nhost.charAt(ind+1) == &apos;:&apos;) &#123;</span><br><span class="line">                                ++ind ;</span><br><span class="line">                                // port can be null according to RFC2396</span><br><span class="line">                                if (nhost.length() &gt; (ind + 1)) &#123;</span><br><span class="line">                                    port = Integer.parseInt(nhost.substring(ind+1));</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                throw new IllegalArgumentException(</span><br><span class="line">                                    &quot;Invalid authority field: &quot; + authority);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        throw new IllegalArgumentException(</span><br><span class="line">                            &quot;Invalid authority field: &quot; + authority);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    ind = host.indexOf(&apos;:&apos;);</span><br><span class="line">                    port = -1;</span><br><span class="line">                    if (ind &gt;= 0) &#123;</span><br><span class="line">                        // port can be null according to RFC2396</span><br><span class="line">                        if (host.length() &gt; (ind + 1)) &#123;</span><br><span class="line">                            port = Integer.parseInt(host.substring(ind + 1));</span><br><span class="line">                        &#125;</span><br><span class="line">                        host = host.substring(0, ind);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                host = &quot;&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            if (port &lt; -1)</span><br><span class="line">                throw new IllegalArgumentException(&quot;Invalid port number :&quot; +</span><br><span class="line">                                                   port);</span><br><span class="line">            start = i;</span><br><span class="line">            // If the authority is defined then the path is defined by the</span><br><span class="line">            // spec only; See RFC 2396 Section 5.2.4.</span><br><span class="line">            if (authority != null &amp;&amp; authority.length() &gt; 0)</span><br><span class="line">                path = &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (host == null) &#123;</span><br><span class="line">            host = &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Parse the file path if any</span><br><span class="line">        if (start &lt; limit) &#123;</span><br><span class="line">            if (spec.charAt(start) == &apos;/&apos;) &#123;</span><br><span class="line">                path = spec.substring(start, limit);</span><br><span class="line">            &#125; else if (path != null &amp;&amp; path.length() &gt; 0) &#123;</span><br><span class="line">                isRelPath = true;</span><br><span class="line">                int ind = path.lastIndexOf(&apos;/&apos;);</span><br><span class="line">                String seperator = &quot;&quot;;</span><br><span class="line">                if (ind == -1 &amp;&amp; authority != null)</span><br><span class="line">                    seperator = &quot;/&quot;;</span><br><span class="line">                path = path.substring(0, ind + 1) + seperator +</span><br><span class="line">                         spec.substring(start, limit);</span><br><span class="line"></span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                String seperator = (authority != null) ? &quot;/&quot; : &quot;&quot;;</span><br><span class="line">                path = seperator + spec.substring(start, limit);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (queryOnly &amp;&amp; path != null) &#123;</span><br><span class="line">            int ind = path.lastIndexOf(&apos;/&apos;);</span><br><span class="line">            if (ind &lt; 0)</span><br><span class="line">                ind = 0;</span><br><span class="line">            path = path.substring(0, ind) + &quot;/&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        if (path == null)</span><br><span class="line">            path = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">        if (isRelPath) &#123;</span><br><span class="line">            // Remove embedded /./</span><br><span class="line">            while ((i = path.indexOf(&quot;/./&quot;)) &gt;= 0) &#123;</span><br><span class="line">                path = path.substring(0, i) + path.substring(i + 2);</span><br><span class="line">            &#125;</span><br><span class="line">            // Remove embedded /../ if possible</span><br><span class="line">            i = 0;</span><br><span class="line">            while ((i = path.indexOf(&quot;/../&quot;, i)) &gt;= 0) &#123;</span><br><span class="line">                /*</span><br><span class="line">                 * A &quot;/../&quot; will cancel the previous segment and itself,</span><br><span class="line">                 * unless that segment is a &quot;/../&quot; itself</span><br><span class="line">                 * i.e. &quot;/a/b/../c&quot; becomes &quot;/a/c&quot;</span><br><span class="line">                 * but &quot;/../../a&quot; should stay unchanged</span><br><span class="line">                 */</span><br><span class="line">                if (i &gt; 0 &amp;&amp; (limit = path.lastIndexOf(&apos;/&apos;, i - 1)) &gt;= 0 &amp;&amp;</span><br><span class="line">                    (path.indexOf(&quot;/../&quot;, limit) != 0)) &#123;</span><br><span class="line">                    path = path.substring(0, limit) + path.substring(i + 3);</span><br><span class="line">                    i = 0;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    i = i + 3;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // Remove trailing .. if possible</span><br><span class="line">            while (path.endsWith(&quot;/..&quot;)) &#123;</span><br><span class="line">                i = path.indexOf(&quot;/..&quot;);</span><br><span class="line">                if ((limit = path.lastIndexOf(&apos;/&apos;, i - 1)) &gt;= 0) &#123;</span><br><span class="line">                    path = path.substring(0, limit+1);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // Remove starting .</span><br><span class="line">            if (path.startsWith(&quot;./&quot;) &amp;&amp; path.length() &gt; 2)</span><br><span class="line">                path = path.substring(2);</span><br><span class="line"></span><br><span class="line">            // Remove trailing .</span><br><span class="line">            if (path.endsWith(&quot;/.&quot;))</span><br><span class="line">                path = path.substring(0, path.length() -1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setURL(u, protocol, host, port, authority, userInfo, path, query, ref);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到上面注释 “这里——hf” 的地方，特殊符号是写死的。这就是为什么特殊字符会有坑的存在。</p>
<ul>
<li>2 访问和验证登录信息分开<br>分别定义 userInfo 和 url。<br>eg：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String userName = &quot;hanfeng&quot;;</span><br><span class="line">String passWord = &quot;123&quot;;</span><br><span class="line">String domainIp = &quot;172.16.192.156&quot;;</span><br><span class="line">String url = &quot;Smb://172.16.192.156/share&quot;;</span><br><span class="line">NtlmPasswordAuthentication auth = new NtlmPasswordAuthentication(domainIp, userName, passWord);</span><br><span class="line">SmbFile smbFile = new SmbFile(url, auth);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>构造器源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public SmbFile( String url, NtlmPasswordAuthentication auth )</span><br><span class="line">                    throws MalformedURLException &#123;</span><br><span class="line">        this( new URL( null, url, Handler.SMB_HANDLER ), auth );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>this调用的源：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">public SmbFile( URL url, NtlmPasswordAuthentication auth ) &#123;</span><br><span class="line">        super( url );</span><br><span class="line">        this.auth = auth == null ? new NtlmPasswordAuthentication( url.getUserInfo() ) : auth;</span><br><span class="line"></span><br><span class="line">        getUncPath0();</span><br><span class="line">    &#125;</span><br><span class="line">    SmbFile( SmbFile context, String name, int type,</span><br><span class="line">                int attributes, long createTime, long lastModified, long size )</span><br><span class="line">                throws MalformedURLException, UnknownHostException &#123;</span><br><span class="line">        this( context.isWorkgroup0() ?</span><br><span class="line">            new URL( null, &quot;smb://&quot; + name + &quot;/&quot;, Handler.SMB_HANDLER ) :</span><br><span class="line">            new URL( context.url, name + (( attributes &amp; ATTR_DIRECTORY ) &gt; 0 ? &quot;/&quot; : &quot;&quot; )));</span><br><span class="line"></span><br><span class="line">        /* why was this removed before? DFS? copyTo? Am I going around in circles? */</span><br><span class="line">        auth = context.auth;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if( context.share != null ) &#123;</span><br><span class="line">            this.tree = context.tree;</span><br><span class="line">            this.dfsReferral = context.dfsReferral;</span><br><span class="line">        &#125;</span><br><span class="line">        int last = name.length() - 1;</span><br><span class="line">        if( name.charAt( last ) == &apos;/&apos; ) &#123;</span><br><span class="line">            name = name.substring( 0, last );</span><br><span class="line">        &#125;</span><br><span class="line">        if( context.share == null ) &#123;</span><br><span class="line">            this.unc = &quot;\\&quot;;</span><br><span class="line">        &#125; else if( context.unc.equals( &quot;\\&quot; )) &#123;</span><br><span class="line">            this.unc = &apos;\\&apos; + name;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            this.unc = context.unc + &apos;\\&apos; + name;</span><br><span class="line">        &#125;</span><br><span class="line">    /* why? am I going around in circles?</span><br><span class="line">     *  this.type = type == TYPE_WORKGROUP ? 0 : type;</span><br><span class="line">     */</span><br><span class="line">        this.type = type;</span><br><span class="line">        this.attributes = attributes;</span><br><span class="line">        this.createTime = createTime;</span><br><span class="line">        this.lastModified = lastModified;</span><br><span class="line">        this.size = size;</span><br><span class="line">        isExists = true;</span><br><span class="line"></span><br><span class="line">        attrExpiration = sizeExpiration =</span><br><span class="line">                System.currentTimeMillis() + attrExpirationPeriod;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="4、实现文件的读写"><a href="#4、实现文件的读写" class="headerlink" title="4、实现文件的读写"></a>4、实现文件的读写</h2><p>那么上面我们已将连接好了我们想要连接的服务器目录，如何实现文件的读写呢？<br>要实现读写要有个前提，就是在目标服务器上给我们当前使用用户授予读写的权限，否则是会出问题的。</p>
<p>一般我们读取文件都是用 FileInputStream，那么smbFile可不可以使用 FileInputStream来读取呢？<br><img src="/img/smb_4.png" alt="6"></p>
<p>那么怎么解决？？？？？</p>
<p>在 InputStream 下有个子类（非 jdk 提供，或者可以说是个人实现的），叫 <code>SmbFileInputStream</code><br>我们来试下这个是不是好用：<br><img src="/img/smb_5.png" alt="7"><br>没有问题，是可以的，我们来看下 <code>SmbFileInputStream</code> 的实现：</p>
<p><img src="/img/smb_6.png" alt="8"><br>我们可以清楚的看到 <code>SmbFileInputStream</code> 实际上也是继承了 <code>InputStream</code>。<br> 这样我们就可以根绝我们熟悉的 InputStream  去操作流了。</p>
<p> 但是  SmbFile 不能用并发来实现，因为没有意义，他的底层全部使用了 <code>synchronized</code> ，即使你用并发，也是放在队列里，一条一条处理。想了解细节的可以去看下源码，这里就不过多说了。</p>
<h2 id="5、最后附上完整的读写示例代码："><a href="#5、最后附上完整的读写示例代码：" class="headerlink" title="5、最后附上完整的读写示例代码："></a>5、最后附上完整的读写示例代码：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">package com.thunisoft.fy.dzjz.fiveimport.service;</span><br><span class="line"></span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.OutputStream;</span><br><span class="line"></span><br><span class="line">import jcifs.smb.NtlmPasswordAuthentication;</span><br><span class="line">import jcifs.smb.SmbFile;</span><br><span class="line">import jcifs.smb.SmbFileInputStream;</span><br><span class="line">import jcifs.smb.SmbFileOutputStream;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.io.IOUtils;</span><br><span class="line">import org.apache.commons.lang.StringUtils;</span><br><span class="line"></span><br><span class="line">public class SmbFileRead &#123;</span><br><span class="line"></span><br><span class="line">    /**smb协议头*/</span><br><span class="line">    private final String SMB_URL_TOP = &quot;smb://&quot;;</span><br><span class="line"></span><br><span class="line">    /**用户名*/</span><br><span class="line">    private final String SMB_USER = &quot;hanfeng&quot;;</span><br><span class="line"></span><br><span class="line">    /**斜杠*/</span><br><span class="line">    private final String SMB_URL_SLANSH = &quot;/&quot;;</span><br><span class="line"></span><br><span class="line">    /**密码*/</span><br><span class="line">    private final String SMB_PASSWORD = &quot;123&quot;;</span><br><span class="line"></span><br><span class="line">    /**base folder*/</span><br><span class="line">    private final String SMB_BASE_FOLDER_NAME = &quot;share&quot;;</span><br><span class="line"></span><br><span class="line">    /**IP*/</span><br><span class="line">    private String SMB_IP = &quot;172.16.192.156&quot;;</span><br><span class="line"></span><br><span class="line">    /**url*/</span><br><span class="line">    private String SMB_URL = StringUtils.EMPTY;</span><br><span class="line"></span><br><span class="line">    /**用户信息*/</span><br><span class="line">    private NtlmPasswordAuthentication auth = null;</span><br><span class="line"></span><br><span class="line">    public void init() &#123;</span><br><span class="line">        if (null == this.auth) &#123;</span><br><span class="line">            this.auth = new NtlmPasswordAuthentication(SMB_IP, SMB_USER, SMB_PASSWORD);</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isBlank(this.SMB_URL)) &#123;</span><br><span class="line">            this.SMB_URL = SMB_URL_TOP + SMB_IP + SMB_URL_SLANSH + SMB_BASE_FOLDER_NAME;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 读</span><br><span class="line">     * @return</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    public InputStream openFile() throws Exception &#123;</span><br><span class="line">        init();</span><br><span class="line">        SmbFile smbFile = new SmbFile(this.SMB_URL, this.auth);</span><br><span class="line">        //        SmbFile outSmbFile=new SmbFile(this.SMB_URL,this.auth);</span><br><span class="line">        //        smbFile.createNewFile();                  //创建文件</span><br><span class="line">        //        smbFile.copyTo(outSmbFile);               //将smbFile copy 到 outSmbFile</span><br><span class="line">        //        smbFile.mkdirs();                         //创建目录（还有 mkdir。mkdirs 支持多级创建，mkdir不支持）</span><br><span class="line">        //        smbFile.listFiles();                      //获取子文件/文件夹</span><br><span class="line">        return new SmbFileInputStream(smbFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void writeFile() throws Exception &#123;</span><br><span class="line">        InputStream in = openFile();</span><br><span class="line">        SmbFile smbFile = new SmbFile(this.SMB_URL, this.auth);//目标地址  这里我就不改了  人懒 ^V^.</span><br><span class="line">        /**</span><br><span class="line">         * 验证文件 或者文件夹是否存在  不存在先创建</span><br><span class="line">         */</span><br><span class="line">        if (!smbFile.exists()) &#123;</span><br><span class="line">            smbFile.createNewFile();</span><br><span class="line">            //  文件夹创建</span><br><span class="line">            smbFile.mkdirs();</span><br><span class="line">            //注：穿件文件不能包含目录创建，需要先创建目录在创建文件</span><br><span class="line">        &#125;</span><br><span class="line">        OutputStream out = new SmbFileOutputStream(smbFile);</span><br><span class="line">        IOUtils.copy(in, out);</span><br><span class="line">        //因为 IOUtils 中没有给刷新输出流，也没有关流 ，所以需要自己来处理</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">        in.close();</span><br><span class="line">        /**</span><br><span class="line">         * 一般情况下是：先打开的后关闭，后打开的先关闭</span><br><span class="line">         * 另一种情况：看依赖关系，如果流a依赖流b，应该先关闭流a，再关闭流b</span><br><span class="line">         * 例如处理流a依赖节点流b，应该先关闭处理流a，再关闭节点流b</span><br><span class="line">         * 当然完全可以只关闭处理流，不用关闭节点流。处理流关闭的时候，会调用其处理的节点流的关闭方法</span><br><span class="line">         * 如果将节点流关闭以后再关闭处理流，会抛出IO异常</span><br><span class="line">         */</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转载请说明出处<a href="http://hanfeng.me/2018/01/21/SMB%20%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BD%BF%E7%94%A8%EF%BC%88%E5%8E%9F%E5%88%9B%EF%BC%89/" target="_blank" rel="noopener">http://hanfeng.me/2018/01/21/SMB%20%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BD%BF%E7%94%A8%EF%BC%88%E5%8E%9F%E5%88%9B%EF%BC%89/</a>;<br>欢迎拍砖。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
        
<div class="counter-tag counter">
    <span id="/2018/01/21/SMB 协议的使用（原创）/" class="leancloud_visitors post-title-link" style="font-size: 12px" data-flag-title="SMB 协议的使用（原创）">
         &nbsp;
        view
    </span>
</div>

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>


 








  
    <article id="post-Maven 常用命令" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/01/15/Maven 常用命令/" class="article-date">
  	<time datetime="2018-01-14T16:00:00.000Z" itemprop="datePublished">2018-01-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/15/Maven 常用命令/">
        Maven 常用命令
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<p>Maven库：<a href="http://repo2.maven.org/maven2/" target="_blank" rel="noopener">http://repo2.maven.org/maven2/</a><br>Maven依赖查询：<a href="http://mvnrepository.com/" target="_blank" rel="noopener">http://mvnrepository.com/</a></p>
<ol>
<li><p>创建Maven的普通java项目：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:create </span><br><span class="line">-DgroupId=packageName </span><br><span class="line">-DartifactId=projectName</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>创建Maven的Web项目：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:create </span><br><span class="line">-DgroupId=packageName    </span><br><span class="line">-DartifactId=webappName </span><br><span class="line">-DarchetypeArtifactId=maven-archetype-webapp</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p>编译源代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn compile</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译测试代码：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn test-compile</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行测试：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn test</span><br></pre></td></tr></table></figure>
</li>
<li><p>产生site：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn site</span><br></pre></td></tr></table></figure>
</li>
<li><p>打包：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package</span><br></pre></td></tr></table></figure>
</li>
<li><p>在本地Repository中安装jar：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn install</span><br></pre></td></tr></table></figure>
</li>
<li><p>清除产生的项目：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成eclipse项目：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn eclipse:eclipse</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成idea项目：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn idea:idea</span><br></pre></td></tr></table></figure>
</li>
<li><p>组合使用goal命令，如只打包不测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn -Dtest package</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译测试的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn test-compile</span><br></pre></td></tr></table></figure>
</li>
<li><p>只打jar包: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn jar:jar</span><br></pre></td></tr></table></figure>
</li>
<li><p>只测试而不编译，也不测试编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn test -skipping compile -skipping test-compile </span><br><span class="line">      ( -skipping 的灵活运用，当然也可以用于其他组合命令)</span><br></pre></td></tr></table></figure>
</li>
<li><p>清除eclipse的一些系统设置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn eclipse:clean</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>一般使用情况是这样，首先通过 cvs 或 svn 下载代码到本机，然后执行<code>mvn eclipse:eclipse</code>生成ecllipse项目文件，然后导入到eclipse就行了；修改代码后执行mvn compile或mvn test检验，也可以下载eclipse的maven插件。</p>
<ol start="17">
<li>Maven 的其他的命令</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">mvn -version/-v</td>
<td style="text-align:left">显示版本信息</td>
</tr>
<tr>
<td style="text-align:left">mvn archetype:generate</td>
<td style="text-align:left">创建 mvn项目</td>
</tr>
<tr>
<td style="text-align:left">mvn archetype:create -DgroupId=com.oreilly -DartifactId=my-app</td>
<td style="text-align:left">创建 mvn项目</td>
</tr>
<tr>
<td style="text-align:left">mvn package</td>
<td style="text-align:left">生成target目录，编译、测试代码，生成测试报告，生成jar/war文件</td>
</tr>
<tr>
<td style="text-align:left">mvn jetty:run</td>
<td style="text-align:left">运行项目于jetty上,</td>
</tr>
<tr>
<td style="text-align:left">mvn compile</td>
<td style="text-align:left">编译</td>
</tr>
<tr>
<td style="text-align:left">mvn test</td>
<td style="text-align:left">编译并测试</td>
</tr>
<tr>
<td style="text-align:left">mvn clean</td>
<td style="text-align:left">清空生成的文件</td>
</tr>
<tr>
<td style="text-align:left">mvn site</td>
<td style="text-align:left">生成项目相关信息的网站</td>
</tr>
<tr>
<td style="text-align:left">mvn -Dwtpversion=1.0 eclipse:eclipse</td>
<td style="text-align:left">生成Wtp插件的Web项目</td>
</tr>
<tr>
<td style="text-align:left">mvn -Dwtpversion=1.0 eclipse:clean</td>
<td style="text-align:left">清除Eclipse项目的配置信息(Web项目)</td>
</tr>
<tr>
<td style="text-align:left">mvn eclipse:eclipse</td>
<td style="text-align:left">将项目转化为Eclipse项目</td>
</tr>
<tr>
<td style="text-align:left">mvn -e</td>
<td style="text-align:left">显示详细错误 信息.</td>
</tr>
<tr>
<td style="text-align:left">mvn validate</td>
<td style="text-align:left">验证工程是否正确，所有需要的资源是否可用。</td>
</tr>
<tr>
<td style="text-align:left">mvn test-compile</td>
<td style="text-align:left">编译项目测试代码。 。</td>
</tr>
<tr>
<td style="text-align:left">mvn integration-test</td>
<td style="text-align:left">在集成测试可以运行的环境中处理和发布包。</td>
</tr>
<tr>
<td style="text-align:left">mvn verify</td>
<td style="text-align:left">运行任何检查，验证包是否有效且达到质量标准。</td>
</tr>
<tr>
<td style="text-align:left">mvn generate-sources</td>
<td style="text-align:left">产生应用需要的任何额外的源代码，如xdoclet。</td>
</tr>
<tr>
<td style="text-align:left">mvn help:describe -Dplugin=help</td>
<td style="text-align:left">使用 help 插件的  describe 目标来输出Maven Help 插件的信息。</td>
</tr>
<tr>
<td style="text-align:left">mvn help:describe -Dplugin=help -Dfull</td>
<td style="text-align:left">使用Help插件输出完整的带有参数的目标列</td>
</tr>
<tr>
<td style="text-align:left">mvn help:describe -Dplugin=compiler -Dmojo=compile -Dfull</td>
<td style="text-align:left">获取单个目标的信息,设置  mojo 参数和  plugin 参数。此命令列出了Compiler插件的compile 目标的所有信息</td>
</tr>
<tr>
<td style="text-align:left">mvn help:describe -Dplugin=exec -Dfull</td>
<td style="text-align:left">列出所有 Maven Exec 插件可用的目标</td>
</tr>
<tr>
<td style="text-align:left">mvn help:effective-pom</td>
<td style="text-align:left">看这个“有效的 (effective)”POM，它暴露了Maven的默认设置</td>
</tr>
<tr>
<td style="text-align:left">mvn archetype:create -DgroupId=org.sonatype.mavenbook.ch03 -DartifactId=simple -DpackageName=org.sonatype.mavenbook</td>
<td style="text-align:left">创建Maven的普通java项目，在命令行使用Maven Archetype 插件</td>
</tr>
<tr>
<td style="text-align:left">mvn exec:java -Dexec.mainClass=org.sonatype.mavenbook.weather.Main</td>
<td style="text-align:left">Exec 插件让我们能够在不往 classpath 载入适当的依赖的情况下，运行这个程序</td>
</tr>
<tr>
<td style="text-align:left">mvn dependency:resolve</td>
<td style="text-align:left">打印出已解决依赖的列表</td>
</tr>
<tr>
<td style="text-align:left">mvn dependency:tree</td>
<td style="text-align:left">打印整个依赖树</td>
</tr>
<tr>
<td style="text-align:left">mvn install -X</td>
<td style="text-align:left">想要查看完整的依赖踪迹，包含那些因为冲突或者其它原因而被拒绝引入的构件，打开 Maven 的调试标记运行</td>
</tr>
<tr>
<td style="text-align:left">mvn install -Dmaven.test.skip=true</td>
<td style="text-align:left">给任何目标添加maven.test.skip属性就能跳过测试</td>
</tr>
<tr>
<td style="text-align:left">mvn install assembly:assembly</td>
<td style="text-align:left">构建装配Maven Assembly插件是一个用来创建你应用程序特有分发包的插件</td>
</tr>
<tr>
<td style="text-align:left">mvn jetty:run</td>
<td style="text-align:left">调用 Jetty 插件的 Run 目标在 Jetty Servlet 容器中启动 web 应用</td>
</tr>
<tr>
<td style="text-align:left">mvn compile</td>
<td style="text-align:left">编译你的项目</td>
</tr>
<tr>
<td style="text-align:left">mvn clean install</td>
<td style="text-align:left">删除再编译</td>
</tr>
<tr>
<td style="text-align:left">mvn hibernate3:hbm2ddl</td>
<td style="text-align:left">使用 Hibernate3 插件构造数据库</td>
</tr>
</tbody>
</table>
<ol start="18">
<li><p>在应用程序用使用多个存储库 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;repositories&gt;    </span><br><span class="line">    &lt;repository&gt;      </span><br><span class="line">        &lt;id&gt;Ibiblio&lt;/id&gt;      </span><br><span class="line">        &lt;name&gt;Ibiblio&lt;/name&gt;      </span><br><span class="line">        &lt;url&gt;http://www.ibiblio.org/maven/&lt;/url&gt;    </span><br><span class="line">    &lt;/repository&gt;    </span><br><span class="line">    &lt;repository&gt;      </span><br><span class="line">        &lt;id&gt;PlanetMirror&lt;/id&gt;      </span><br><span class="line">        &lt;name&gt;Planet Mirror&lt;/name&gt;      </span><br><span class="line">        &lt;url&gt;http://public.planetmirror.com/pub/maven/&lt;/url&gt;    </span><br><span class="line">    &lt;/repository&gt;  </span><br><span class="line">&lt;/repositories&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mvn deploy:deploy-file </span><br><span class="line">-DgroupId=com </span><br><span class="line">-DartifactId=client </span><br><span class="line">-Dversion=0.1.0 </span><br><span class="line">-Dpackaging=jar </span><br><span class="line">-Dfile=d:\client-0.1.0.jar </span><br><span class="line">-DrepositoryId=maven-repository-inner</span><br><span class="line">-Durl=ftp://xxxxxxx/opt/maven/repository/</span><br></pre></td></tr></table></figure>
</code></pre><ol start="19">
<li>发布第三方Jar到本地库中</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mvn install:install-file </span><br><span class="line">-DgroupId=com </span><br><span class="line">-DartifactId=client </span><br><span class="line">-Dversion=0.1.0 </span><br><span class="line">-Dpackaging=jar </span><br><span class="line">-Dfile=d:\client-0.1.0.jar </span><br><span class="line">-DdownloadSources=true </span><br><span class="line">-DdownloadJavadocs=true</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
        
<div class="counter-tag counter">
    <span id="/2018/01/15/Maven 常用命令/" class="leancloud_visitors post-title-link" style="font-size: 12px" data-flag-title="Maven 常用命令">
         &nbsp;
        view
    </span>
</div>

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>


 








  
    <article id="post-表达式语言_spring" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/17/表达式语言_spring/" class="article-date">
  	<time datetime="2017-09-16T16:00:00.000Z" itemprop="datePublished">2017-09-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/17/表达式语言_spring/">
        表达式语言_ spring
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Espresdsion-Language"><a href="#Spring-Espresdsion-Language" class="headerlink" title="Spring Espresdsion Language"></a>Spring Espresdsion Language</h1><p>Spring表达式语言（简称SpEL）是一个支持查询并在运行时操纵一个对象图的功能强大的表达式语言。SpEL语言的语法类似于统一EL，但提供了更多的功能，最主要的是显式方法调用和基本字符串模板函数。</p>
<p>同很多可用的Java 表达式语言相比，例如OGNL，MVEL和JBoss EL，SpEL的诞生是为了给Spring社区提供一个可以给Spring目录中所有产品提供单一良好支持的表达式语言。其语言特性由Spring目录中的项目需求驱动，包括基于eclipse的SpringSource套件中的代码补全工具需求。也就是说，SpEL是一个基于技术中立的API允许需要时与其他表达式语言集成。</p>
<p>SpEL作为Spring目录中表达式求值的基础，它并不是直接依赖于Spring而是可以被独立使用。为了能够自包含，本章中的许多示例把SpEL作为一个独立的表达式语言来使用。这就需要创建一些如解析器的引导基础组件类。大多数Spring用户只需要为求值编写表达式字符串而不需要关心这些基础组件</p>
<p>SpEL 的功能特性：</p>
<ul>
<li>字符表达式</li>
<li>布尔和关系操作符</li>
<li>正则表达式</li>
<li>类表达式</li>
<li>访问properties，arrays，lists，maps</li>
<li>方法调用</li>
<li>关系操作符</li>
<li>赋值</li>
<li>调用构造器</li>
<li>三元操作符</li>
<li>变量</li>
<li>用户自定义函数</li>
<li>集合投影</li>
<li>集合选择</li>
<li>模板表达式<h2 id="使用-spring-表达式语言"><a href="#使用-spring-表达式语言" class="headerlink" title="使用 spring 表达式语言"></a>使用 spring 表达式语言</h2></li>
</ul>
<ol>
<li>新建一个Maven Web项目，添加依赖，pom.xml如下所示：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.ceshi.test&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;Spring053&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;name&gt;Spring053&lt;/name&gt;</span><br><span class="line">    &lt;url&gt;http://maven.apache.org&lt;/url&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;spring.version&gt;4.3.0.RELEASE&lt;/spring.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">            &lt;version&gt;4.10&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.aspectj&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.8.9&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;cglib&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;cglib&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.2.4&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>为了IOC，定义了用户类User.java与Order.java，如下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">package com.ceshi.test.Spring053;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 订单类</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class Order &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 订单名称</span><br><span class="line">     */</span><br><span class="line">    private String orderName;</span><br><span class="line">    /*</span><br><span class="line">     * 用户姓名</span><br><span class="line">     */</span><br><span class="line">    private String userName;</span><br><span class="line">    /**</span><br><span class="line">     * 用户对象</span><br><span class="line">     */</span><br><span class="line">    private User customer;</span><br><span class="line"></span><br><span class="line">    public String getOrderName() &#123;</span><br><span class="line">        return orderName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setOrderName(String orderName) &#123;</span><br><span class="line">        this.orderName = orderName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public User getCustomer() &#123;</span><br><span class="line">        return customer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCustomer(User customer) &#123;</span><br><span class="line">        this.customer = customer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getUserName() &#123;</span><br><span class="line">        return userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUserName(String userName) &#123;</span><br><span class="line">        this.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;订单名：&quot;+this.getOrderName()+&quot;,姓名：&quot;+this.getUserName()+&quot;,编号：&quot;+this.getCustomer().getId();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">package com.ceshi.test.Spring053.spel01;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 订单类</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class Order &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 订单名称</span><br><span class="line">     */</span><br><span class="line">    private String orderName;</span><br><span class="line">    /*</span><br><span class="line">     * 用户姓名</span><br><span class="line">     */</span><br><span class="line">    private String userName;</span><br><span class="line">    /**</span><br><span class="line">     * 用户对象</span><br><span class="line">     */</span><br><span class="line">    private User customer;</span><br><span class="line"></span><br><span class="line">    public String getOrderName() &#123;</span><br><span class="line">        return orderName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setOrderName(String orderName) &#123;</span><br><span class="line">        this.orderName = orderName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public User getCustomer() &#123;</span><br><span class="line">        return customer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCustomer(User customer) &#123;</span><br><span class="line">        this.customer = customer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getUserName() &#123;</span><br><span class="line">        return userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUserName(String userName) &#123;</span><br><span class="line">        this.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>编写容器初始化的配置文件spel01.xml，内容如下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop</span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop-4.3.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;gyl&quot; class=&quot;com.ceshi.test.Spring053.spel01.User&quot; p:id=&quot;9527&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;name&quot; value=&quot;张三&quot;&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;bean id=&quot;order001&quot; class=&quot;com.ceshi.test.Spring053.spel01.Order&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;customer&quot; ref=&quot;gyl&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;name&quot; value=&quot;#&#123;gyl.name&#125;&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;orderName&quot; value=&apos;#&#123;&quot;Apples&quot;.toUpperCase()&#125;&apos;&gt;&lt;/property&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>复制代码<br>在配置文件中，出现了#｛｝形式的表达式，我们就称为Spel表达式。#{gyl.name}作用是找到名称为gyl的bean取出中间的name值；#{“Apples”.toUpperCase()}把字符串Apples转换成大写并输出。</p>
<ol start="4">
<li>取出bean测试<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.ceshi.test.Spring053.spel01;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.ApplicationContext;</span><br><span class="line">import org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ApplicationContext ctx=new ClassPathXmlApplicationContext(&quot;spel01.xml&quot;);</span><br><span class="line">        Order order=ctx.getBean(&quot;order001&quot;,Order.class);</span><br><span class="line">        System.out.println(order);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//运行结果：订单名：APPLES，姓名：张三，编号：9527</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="SpEL表达式Hello-World"><a href="#SpEL表达式Hello-World" class="headerlink" title="SpEL表达式Hello World!"></a>SpEL表达式Hello World!</h2><p>Spring表达式语言(SpEL)从3.X开始支持，它是一种能够支持运行时查询和操作对象图的强大的表达式，其表达式语法类似于统一表达式语言。</p>
<p>SpEL支持如下表达式：</p>
<ul>
<li>基本表达式：字面量表达式、关系，逻辑与算数运算表达式、字符串连接及截取表达式、三目运算、正则表达式、括号优先级表达式；</li>
<li>类相关表达式：类类型表达式、类实例化、instanceof表达式、变量定义及引用、赋值表达式、自定义函数、对象属性存取及安全导航表达式、对象方法调用、Bean引用；</li>
<li>集合相关表达式：内联List、内联数组、集合，字典访问、列表，字典，数组修改、集合投影、集合选择；不支持多维内联数组初始化；不支持内联字典定义；</li>
<li>其他表达式：模板表达式.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package com.ceshi.test.Spring053.spel02;</span><br><span class="line"></span><br><span class="line">import org.springframework.expression.Expression;</span><br><span class="line">import org.springframework.expression.ExpressionParser;</span><br><span class="line">import org.springframework.expression.spel.standard.SpelExpressionParser;</span><br><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //创建SpEL表达式的解析器</span><br><span class="line">        ExpressionParser parser=new SpelExpressionParser();</span><br><span class="line">        //解析表达式&apos;Hello &apos;+&apos; World!&apos;</span><br><span class="line">        Expression exp=parser.parseExpression(&quot;&apos;Hello &apos;+&apos; World!&apos;&quot;);</span><br><span class="line">        //取出解析结果</span><br><span class="line">        String result=exp.getValue().toString();</span><br><span class="line">        //输出结果</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="SpEL-表达式的运用"><a href="#SpEL-表达式的运用" class="headerlink" title="SpEL 表达式的运用"></a>SpEL 表达式的运用</h2><p>支持的文字表达的类型是字符串，日期，数值（整型，实型，和十六进制），布尔和空。字符串是由单引号分隔。使用反斜杠字符转移把一个单引号字符本身放在字符串中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//创建SpEL表达式的解析器</span><br><span class="line">ExpressionParser ep= new SpelExpressionParser();</span><br><span class="line">System.out.println(ep.parseExpression(&quot;&apos;HelloWorld&apos;&quot;).getValue());</span><br><span class="line">System.out.println(ep.parseExpression(&quot;0xffffff&quot;).getValue());</span><br><span class="line">System.out.println(ep.parseExpression(&quot;1.234345e+3&quot;).getValue());</span><br><span class="line">System.out.println(ep.parseExpression(&quot;new java.util.Date()&quot;).getValue());</span><br><span class="line"> </span><br><span class="line">ExpressionParser parser=new SpelExpressionParser();</span><br><span class="line">User user=new User(9527,&quot;周星驰&quot;);</span><br><span class="line">//解析表达式需要的上下文，解析时有一个默认的上下文</span><br><span class="line">EvaluationContext ctx = new StandardEvaluationContext();</span><br><span class="line">//在上下文中设置变量，变量名为user，内容为user对象</span><br><span class="line">ctx.setVariable(&quot;user&quot;, user);</span><br><span class="line">//从用户对象中获得id，获得解析后的值在ctx上下文中</span><br><span class="line">//User类在前面已定义，这里增加了一个有参构造方法。上面的示例是调用方法，其实可以这样：引用对象属性，只需使用一个句点来表示一个嵌套的属性值</span><br><span class="line">int id = (Integer) parser.parseExpression(&quot;#user.getId()&quot;).getValue(ctx);</span><br><span class="line"></span><br><span class="line">System.out.println(id);</span><br><span class="line"></span><br><span class="line">//运行结果HelloWorld</span><br><span class="line">    16777215</span><br><span class="line">    1234.345</span><br><span class="line">    Fri Jul 01 14:50:59 CST 2017</span><br><span class="line">    </span><br><span class="line">    9527</span><br></pre></td></tr></table></figure>
<p>数组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String[] students=new String[]&#123;&quot;tom&quot;,&quot;jack&quot;,&quot;rose&quot;,&quot;mark&quot;,&quot;lucy&quot;&#125;;</span><br><span class="line">        ctx.setVariable(&quot;students&quot;, students);</span><br><span class="line">        String student = parser.parseExpression(&quot;#students[3]&quot;).getValue(ctx,</span><br><span class="line">                String.class);</span><br><span class="line">        System.out.println(student);</span><br></pre></td></tr></table></figure>
<p>大致使用都是类似的 parser.parseExpression(“ 表达式 “).getValue( 上下文, class)；</p>
<p>parser.parseExpression(“ 表达式 “).getValue(class);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/**关系运算符*/</span><br><span class="line">//true</span><br><span class="line">        boolean trueValue1 = parser.parseExpression(&quot;2 == 2&quot;).getValue(Boolean.class);</span><br><span class="line">        //false</span><br><span class="line">        boolean falseValue1 = parser.parseExpression(&quot;2 &lt; -5.0&quot;).getValue(Boolean.class);</span><br><span class="line">        //true</span><br><span class="line">        boolean trueValue2 = parser.parseExpression(&quot;&apos;black&apos; &lt; &apos;block&apos;&quot;).getValue(Boolean.class);</span><br><span class="line">        //false，字符xyz是否为int类型</span><br><span class="line">        boolean falseValue2 = parser.parseExpression(&quot;&apos;xyz&apos; instanceof T(int)&quot;).getValue(Boolean.class);</span><br><span class="line">        //true，正则是否匹配</span><br><span class="line">        boolean trueValue3 =parser.parseExpression(&quot;&apos;5.00&apos; matches &apos;^-?\\d+(\\.\\d&#123;2&#125;)?$&apos;&quot;).getValue(Boolean.class);</span><br><span class="line">        //false</span><br><span class="line">        boolean falseValue3=parser.parseExpression(&quot;&apos;5.0067&apos; matches &apos;^-?\\d+(\\.\\d&#123;2&#125;)?$&apos;&quot;).getValue(Boolean.class);</span><br><span class="line">/**逻辑运算*/</span><br><span class="line">        //false </span><br><span class="line">        boolean falseValue4 = parser.parseExpression(&quot;true and false&quot;).getValue(Boolean.class);</span><br><span class="line">        //true，isMember方法用于测试是否为某个对象的成员</span><br><span class="line">        String expression = &quot;isMember(&apos;Nikola Tesla&apos;) and isMember(&apos;Mihajlo Pupin&apos;)&quot;;</span><br><span class="line">        boolean trueValue4 = parser.parseExpression(expression).getValue(Boolean.class);</span><br><span class="line">// -- OR 或运算--</span><br><span class="line">        //true</span><br><span class="line">        boolean trueValue5 = parser.parseExpression(&quot;true or false&quot;).getValue(Boolean.class);</span><br><span class="line">        //true</span><br><span class="line">        String expression1 = &quot;isMember(&apos;Nikola Tesla&apos;) or isMember(&apos;Albert Einstein&apos;)&quot;;</span><br><span class="line">        boolean trueValue6 = parser.parseExpression(expression).getValue( Boolean.class);</span><br><span class="line">        //false</span><br><span class="line">        boolean falseValue5 = parser.parseExpression(&quot;!true&quot;).getValue(Boolean.class);</span><br><span class="line">        //false</span><br><span class="line">        String expression2 = &quot;isMember(&apos;Nikola Tesla&apos;) and !isMember(&apos;Mihajlo Pupin&apos;)&quot;;</span><br><span class="line">        boolean falseValue6 = parser.parseExpression(expression).getValue(Boolean.class);</span><br><span class="line">        // Addition</span><br><span class="line">        int two = parser.parseExpression(&quot;1 + 1&quot;).getValue(Integer.class); </span><br><span class="line">        // 2</span><br><span class="line">        String testString =</span><br><span class="line">        parser.parseExpression(&quot;&apos;test&apos; + &apos; &apos; + &apos;string&apos;&quot;).getValue(String.class); // &apos;test string&apos;</span><br><span class="line">        // Subtraction</span><br><span class="line">        int four = parser.parseExpression(&quot;1 - -3&quot;).getValue(Integer.class); // 4</span><br><span class="line">        double d = parser.parseExpression(&quot;1000.00 - 1e4&quot;).getValue(Double.class); // -9000</span><br><span class="line">        // Multiplication</span><br><span class="line">        int six = parser.parseExpression(&quot;-2 * -3&quot;).getValue(Integer.class); // 6</span><br><span class="line">        double twentyFour = parser.parseExpression(&quot;2.0 * 3e0 * 4&quot;).getValue(Double.class); // 24.0</span><br><span class="line">        // Division</span><br><span class="line">        int minusTwo = parser.parseExpression(&quot;6 / -3&quot;).getValue(Integer.class); // -2</span><br><span class="line">        double one = parser.parseExpression(&quot;8.0 / 4e0 / 2&quot;).getValue(Double.class); // 1.0</span><br><span class="line">        // Modulus</span><br><span class="line">        int three = parser.parseExpression(&quot;7 % 4&quot;).getValue(Integer.class); // 3</span><br><span class="line">        int one = parser.parseExpression(&quot;8 / 5 % 2&quot;).getValue(Integer.class); // 1</span><br><span class="line">        // Operator precedence</span><br><span class="line">        int minusTwentyOne = parser.parseExpression(&quot;1+2-3*8&quot;).getValue(Integer.class); // -21</span><br></pre></td></tr></table></figure>
<p>基于 XML 配置定义 Bean<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;gyl&quot; class=&quot;com.ceshi.test.Spring053.spel01.User&quot; p:id=&quot;9527&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;name&quot; value=&quot;张三&quot;&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;order001&quot; class=&quot;com.ceshi.test.Spring053.spel01.Order&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;customer&quot; ref=&quot;gyl&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;userName&quot; value=&quot;#&#123;gyl.name&#125;&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;property name=&quot;orderName&quot; value=&apos;#&#123;&quot;Apples&quot;.toUpperCase()&#125;&apos;&gt;&lt;/property&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;numberGuess&quot; class=&quot;org.spring.samples.NumberGuess&quot;&gt;</span><br><span class="line">        &lt;!--调用静态方法random() --&gt;</span><br><span class="line">        &lt;property name=&quot;randomNumber&quot; value=&quot;#&#123; T(java.lang.Math).random() * 100.0 &#125;&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;taxCalculator&quot; class=&quot;org.spring.samples.TaxCalculator&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;defaultLocale&quot; value=&quot;#&#123; systemProperties[&apos;user.region&apos;] &#125;&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;numberGuess&quot; class=&quot;org.spring.samples.NumberGuess&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;randomNumber&quot; value=&quot;#&#123; T(java.lang.Math).random() * 100.0 &#125;&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean id=&quot;shapeGuess&quot; class=&quot;org.spring.samples.ShapeGuess&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;initialShapeSeed&quot; value=&quot;#&#123; numberGuess.randomNumber &#125;&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br></pre></td></tr></table></figure></p>
<p>基于注解配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package com.ceshi.test.Spring053.spel03;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 用户类</span><br><span class="line"> */</span><br><span class="line">@Component(&quot;user1&quot;)</span><br><span class="line">public class User &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 编号</span><br><span class="line">     */</span><br><span class="line">    @Value(&quot;#&#123;9527+100&#125;&quot;)</span><br><span class="line">    private int id;</span><br><span class="line">    /**</span><br><span class="line">     * 姓名</span><br><span class="line">     */</span><br><span class="line">    @Value(&quot;#&#123;&apos;Hello&apos;.toUpperCase()&#125;&quot;)</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    public int getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(int id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参见于：<a href="http://www.cnblogs.com/best/p/5748105.html" target="_blank" rel="noopener">http://www.cnblogs.com/best/p/5748105.html</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
        
<div class="counter-tag counter">
    <span id="/2017/09/17/表达式语言_spring/" class="leancloud_visitors post-title-link" style="font-size: 12px" data-flag-title="表达式语言_ spring">
         &nbsp;
        view
    </span>
</div>

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>


 








  
    <article id="post-表达语言_jsp" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/16/表达语言_jsp/" class="article-date">
  	<time datetime="2017-09-15T16:00:00.000Z" itemprop="datePublished">2017-09-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/16/表达语言_jsp/">
        表达式语言_ jsp
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="JSP-中理想功能："><a href="#JSP-中理想功能：" class="headerlink" title="JSP 中理想功能："></a>JSP 中理想功能：</h2><ol>
<li>接收属性；</li>
<li>判断；</li>
<li>输出；</li>
<li>尽量少用scriptlet (脚本片段)；</li>
<li>所以 JSP 中应该尽可能的把功能减少到这个程度。</li>
</ol>
<h2 id="表达式语言的介绍"><a href="#表达式语言的介绍" class="headerlink" title="表达式语言的介绍"></a>表达式语言的介绍</h2><p>表达式语言是为了能够让JSP中更少的包含Java代码；</p>
<p>用表达式语言可以方便地完成输出；</p>
<p>因此表达式语言的目的：</p>
<ul>
<li><p>更方便的显示；</p>
</li>
<li><p>JSP表达式语言（EL）使得访问存储在JavaBean中的数据变得非常简单。</p>
</li>
<li><p>JSPEL既可以用来创建算术表达式也可以用来创建逻辑表达式。</p>
</li>
<li><p>在JSP EL表达式内可以使用整型数，浮点数，字符串，常量true、false，还有null。</p>
</li>
</ul>
<p>一般表达式语言的形式：${…..}</p>
<h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><p>当您需要在 JSP 标签中指定一个属性值时，只需要简单地使用字符串即可,列如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:setProperty name=&quot;box&quot; property=&quot;perimeter&quot; value=&quot;100&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>但是，对于这个标签中的 value 我们还可以动态的来表示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:setProperty name=&quot;box&quot; property=&quot;perimeter&quot; </span><br><span class="line">                 value=&quot;$&#123;testValue&#125;&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>其中 expr 指的是表达式。在 JSP EL 中通用的操作符是 . 和 {} 。这两个操作符允许您通过内嵌的JSP对象访问各种各样的JavaBean属性。<br>假如 testValue 的值是 Hello JSP! ，<br>当JSP编译器在属性中见到”${}”格式后，它会产生代码来计算这个表达式，并且产生一个替代品来代替表达式的值。<br>您也可以在标签的模板文本中使用表达式语言。比如<a href="jsp:text" target="_blank" rel="noopener">jsp:text</a>标签简单地将其主体中的文本插入到JSP输出中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:text&gt;</span><br><span class="line">&lt;h1&gt;Hello JSP!&lt;/h1&gt;</span><br><span class="line">&lt;/jsp:text&gt;</span><br></pre></td></tr></table></figure>
<p>例二：我们设定在值是下面的一组，</p>
<p>request.setAttribute(“name”,”xiazdong”);</p>
<p>${name}即可进行显示；</p>
<p>传统获取属性的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html&quot; pageEncoding=&quot;GBK&quot;%&gt;  </span><br><span class="line">&lt;html&gt;  </span><br><span class="line">    &lt;head&gt;  </span><br><span class="line">        &lt;title&gt;Ttitle&lt;/title&gt;  </span><br><span class="line">    &lt;/head&gt;  </span><br><span class="line">    &lt;body&gt;  </span><br><span class="line">        &lt;%  </span><br><span class="line">            request.setAttribute(&quot;name&quot;,&quot;xiazdong&quot;);  </span><br><span class="line">        %&gt;  </span><br><span class="line">        &lt;%  </span><br><span class="line">            if(request.getAttribute(&quot;name&quot;)!=null)&#123;  </span><br><span class="line">            %&gt;  </span><br><span class="line">                &lt;h3&gt;&lt;%=request.getAttribute(&quot;name&quot;)%&gt;&lt;/h3&gt;  </span><br><span class="line">            &lt;%  </span><br><span class="line">            &#125;  </span><br><span class="line">        %&gt;  </span><br><span class="line">    &lt;/body&gt;  </span><br><span class="line">&lt;/html&gt; </span><br><span class="line">// 上面代码也可以替换成如下代码</span><br><span class="line">&lt;%@ page contentType=&quot;text/html&quot; pageEncoding=&quot;GBK&quot;%&gt;  </span><br><span class="line">&lt;html&gt;  </span><br><span class="line">    &lt;head&gt;  </span><br><span class="line">        &lt;title&gt;Ttitle&lt;/title&gt;  </span><br><span class="line">    &lt;/head&gt;  </span><br><span class="line">    &lt;body&gt;  </span><br><span class="line">        &lt;%  </span><br><span class="line">            request.setAttribute(&quot;name&quot;,&quot;xiazdong&quot;);  </span><br><span class="line">        %&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;name&#125;&lt;/h3&gt;  </span><br><span class="line">    &lt;/body&gt;  </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h2 id="表达式语言的内置对象"><a href="#表达式语言的内置对象" class="headerlink" title="表达式语言的内置对象"></a>表达式语言的内置对象</h2><ol>
<li>pageScope、requestScope、sessionScope、applicationScope内置对象</li>
</ol>
<p>在取得内置对象设置的属性时有用。这些是为了取得page、request、session、application设置的属性，比如：</p>
<ul>
<li>pageContext.setAttribute(“name”,”xiazdong”);</li>
<li>request.setAttribute(“name”,”xiazdong”);同时出现，则通过</li>
<li>${pageScope.name}可以取得page的属性；</li>
<li>${requestScope.name}可以取得request的属性；</li>
</ul>
<ol start="2">
<li>param和paramValues内置对象</li>
</ol>
<ul>
<li>用来接收传来的参数；</li>
<li>param.a类似于request.getParameter(“a”);</li>
<li>paramValues.a类似于request.getParameterValues(“a”);</li>
<li>如果想要取得第二个a的值，则通过${paramValues.a[1]};</li>
</ul>
<ol start="3">
<li>pageContext内置对象</li>
</ol>
<ul>
<li>pageContext对象可以取得request,session,application对象；</li>
<li>pageContext.request取得request内置对象；</li>
<li>pageContext.session取得session内置对象；</li>
<li>pageContext.application取得application对象；</li>
</ul>
<p>还可以调用JSP内置对象的方法：举例：(都是通过反射调用)</p>
<ul>
<li>(1)${pageContext.request.remoteAddr}； 调用getRemoteAddr();</li>
<li>(2)${pageContext.session.new}；调用isNew()函数</li>
<li>(3)${pageContext.session.id};调用getId()函数</li>
</ul>
<ol start="4">
<li>表达式语言用于集合</li>
</ol>
<p>我们可以通过表达式语言很方便的操作集合，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = new ArrayList&lt;Integer&gt;();</span><br><span class="line">request.setAttribute(&quot;a&quot;,list);</span><br><span class="line">$&#123;a[0]&#125;  //表示取得队列中第一个元素；以此类推；</span><br><span class="line"></span><br><span class="line">Map m = new HashMap();</span><br><span class="line">request.setAttribute(&quot;map&quot;,m);</span><br><span class="line">$&#123;map[&quot;a&quot;]&#125; //返回key=a的value；</span><br><span class="line">$&#123;map.a&#125; //返回key=a的value；</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html&quot; pageEncoding=&quot;GBK&quot; import=&quot;java.util.*&quot;%&gt;  </span><br><span class="line">&lt;html&gt;  </span><br><span class="line">    &lt;head&gt;  </span><br><span class="line">        &lt;title&gt;&lt;/title&gt;  </span><br><span class="line">    &lt;/head&gt;  </span><br><span class="line">    &lt;body&gt;  </span><br><span class="line">        &lt;%  </span><br><span class="line">            application.setAttribute(&quot;info&quot;,&quot;application&quot;);  </span><br><span class="line">            session.setAttribute(&quot;info&quot;,&quot;session&quot;);  </span><br><span class="line">            request.setAttribute(&quot;info&quot;,&quot;request&quot;);  </span><br><span class="line">            pageContext.setAttribute(&quot;info&quot;,&quot;page&quot;);  </span><br><span class="line">            List&lt;Integer&gt; list = new ArrayList&lt;Integer&gt;();  </span><br><span class="line">            list.add(1);  </span><br><span class="line">            list.add(2);  </span><br><span class="line">            pageContext.setAttribute(&quot;list&quot;,list);  </span><br><span class="line">            Map&lt;String,String&gt;map = new HashMap&lt;String,String&gt;();  </span><br><span class="line">            map.put(&quot;name&quot;,&quot;xiazdong&quot;);  </span><br><span class="line">            pageContext.setAttribute(&quot;map&quot;,map);  </span><br><span class="line">        %&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;applicationScope.info&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;sessionScope.info&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;requestScope.info&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;pageScope.info&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;pageContext.request.remoteAddr&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;pageContext.session.id&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;pageContext.session.new&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;param.name&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;paramValues.favor[0]&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;paramValues.favor[1]&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;paramValues.favor[2]&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;list[0]&#125;&lt;/h3&gt;  </span><br><span class="line">        &lt;h3&gt;$&#123;map[&quot;name&quot;]&#125;&lt;/h3&gt;  </span><br><span class="line">          </span><br><span class="line">    &lt;/body&gt;  </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>表达式语言用于MVC</li>
</ol>
<p>MVC设计模式是通过Servlet将结果传递给JSP页面显示，如果按照一般的思路，则需要在JSP中导入VO包，因为需要通过VO对象得到属性；比如：</p>
<p>VO是Person类，则JSP中需要以Person per = (Person)request.getAttribute(“person”);</p>
<p>取得Person对象然后显示，从这句话可以看出，我们必须要导入Person类才可以，但是JSP最好只允许导入java.util.*包；<br>所以违背了要求；</p>
<p>如果根据表达式语言，则可以通过在Servlet中编写：</p>
<p>request.setAttribute(“VO”,VO对象); </p>
<p>设置属性，因为requestDispatcher是服务器跳转，因此可以在JSP中通过${VO.属性}取得结果；这样就不用导入VO包；</p>
<p>通过表达式语言可以方便的调用VO的属性；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class A&#123;</span><br><span class="line">    private String a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>传递对象</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A a1 = new A();</span><br><span class="line">request.setAttribute(&quot;obj&quot;,a1);</span><br><span class="line">$&#123;obj.a&#125; //通过反射获得a1对象的a属性；</span><br></pre></td></tr></table></figure>
<ul>
<li>传递多个对象</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">List&lt;A&gt; as = new ArrayList&lt;A&gt;();</span><br><span class="line">request.setAttribute(&quot;as&quot;,as);</span><br><span class="line"></span><br><span class="line">在jsp页面中：</span><br><span class="line">List as = (List)request.getAttribute(&quot;as&quot;);</span><br><span class="line">Iterator iter = as.iterator();</span><br><span class="line">while(iter.hasNext())&#123; //也可以使用 for 循环遍历</span><br><span class="line">    pageContext.setAttribute(&quot;obj&quot;,iter.next());</span><br><span class="line">    $&#123;obj.a&#125;            //调用A类的a属性</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实 JSP 上接收对象和我们在 Java 中遍历一个 list 是一样的。</p>
<ol start="6">
<li>运算符</li>
</ol>
<p>EL表达式支持大部分Java所提供的算术和逻辑操作符：</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>.</td>
<td>row 1 col 2</td>
</tr>
<tr>
<td>.</td>
<td>访问一个Bean属性或者一个映射条目</td>
</tr>
<tr>
<td>[]</td>
<td>访问一个数组或者链表的元素</td>
</tr>
<tr>
<td>( )</td>
<td>组织一个子表达式以改变优先级</td>
</tr>
<tr>
<td>+</td>
<td>加</td>
</tr>
<tr>
<td>-</td>
<td>减或负</td>
</tr>
<tr>
<td>*</td>
<td>乘</td>
</tr>
<tr>
<td>/ or div</td>
<td>除</td>
</tr>
<tr>
<td>% or mod</td>
<td>取模</td>
</tr>
<tr>
<td>== or eq</td>
<td>测试是否相等</td>
</tr>
<tr>
<td>!= or ne</td>
<td>测试是否不等</td>
</tr>
<tr>
<td>&lt; or lt</td>
<td>测试是否小于</td>
</tr>
<tr>
<td>&gt; or gt</td>
<td>测试是否大于</td>
</tr>
<tr>
<td>&lt;= or le</td>
<td>测试是否小于等于</td>
</tr>
<tr>
<td>&gt;= or ge</td>
<td>测试是否大于等于</td>
</tr>
<tr>
<td>&amp;&amp; or and</td>
<td>测试逻辑与</td>
</tr>
<tr>
<td>丨丨 or or</td>
<td>测试逻辑或</td>
</tr>
<tr>
<td>! or not</td>
<td>测试取反</td>
</tr>
<tr>
<td>empty</td>
<td>测试是否空值</td>
</tr>
</tbody>
</table>
<p>使用示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//例一：</span><br><span class="line">&lt;jsp:text&gt;</span><br><span class="line">Box Perimeter is: $&#123;2*box.width + 2*box.height&#125;</span><br><span class="line">&lt;/jsp:text&gt;</span><br><span class="line">//例二：</span><br><span class="line">request.setAttribute(&quot;num1&quot;,20);</span><br><span class="line">request.setAttribute(&quot;num2&quot;,30);</span><br><span class="line">$&#123;num1-num2&#125; //表示减法运算</span><br><span class="line">$&#123;num1&gt;=num2&#125; //表示比较运算</span><br><span class="line">$&#123; empty num2&#125; //表示判断是否为空</span><br></pre></td></tr></table></figure>
<p>本文参见于:</p>
<p><a href="http://blog.csdn.net/xiazdong/article/details/6901497" target="_blank" rel="noopener">http://blog.csdn.net/xiazdong/article/details/6901497</a></p>
<p><a href="http://www.runoob.com/jsp/jsp-expression-language.html" target="_blank" rel="noopener">http://www.runoob.com/jsp/jsp-expression-language.html</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
        
<div class="counter-tag counter">
    <span id="/2017/09/16/表达语言_jsp/" class="leancloud_visitors post-title-link" style="font-size: 12px" data-flag-title="表达式语言_ jsp">
         &nbsp;
        view
    </span>
</div>

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>


 








  
    <article id="post-JNDI 是什么" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/16/JNDI 是什么/" class="article-date">
  	<time datetime="2017-09-15T16:00:00.000Z" itemprop="datePublished">2017-09-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/16/JNDI 是什么/">
        JNDI 是什么
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="JNDI-是什么"><a href="#JNDI-是什么" class="headerlink" title="JNDI 是什么"></a>JNDI 是什么</h1><p><strong>JNDI</strong> ( Java Naming and Directory Interface, Java 命名和目录接口 ) 是 SUN 公司提供的一种标准的 Java 命名系统接口，JNDI 提供统一的客户端 API，通过不同的访问提供者接口 JNDI 服务供应接口 ( SPI ) 的实现，由管理者将 JNDI API 映射为特定的命名服务和目录系统，使得 Java 应用程序可以和这些命名服务和目录服务之间进行交互。</p>
<h2 id="没有-JNDI-的做法："><a href="#没有-JNDI-的做法：" class="headerlink" title="没有 JNDI 的做法："></a>没有 JNDI 的做法：</h2><p>程序员开发时，知道要开发访问 MySQL 数据库的应用，于是将一个对 MySQL JDBC 驱动程序类的引用进行了编码，并通过使用适当的 JDBC URL 连接到数据库。<br>就像以下代码这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Connection conn=null;</span><br><span class="line">try &#123;</span><br><span class="line">  Class.forName(&quot;com.mysql.jdbc.Driver&quot;,</span><br><span class="line">                true, Thread.currentThread().getContextClassLoader());</span><br><span class="line">  conn=DriverManager.getConnection(&quot;jdbc:mysql://MyDBServer?user=qingfeng&amp;password=mingyue&quot;);</span><br><span class="line">  /* 使用conn并进行SQL操作 */</span><br><span class="line">  ......</span><br><span class="line">  conn.close();</span><br><span class="line">&#125; </span><br><span class="line">catch(Exception e) &#123;</span><br><span class="line">  e.printStackTrace();</span><br><span class="line">&#125; </span><br><span class="line">finally &#123;</span><br><span class="line">  if(conn!=null) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      conn.close();</span><br><span class="line">    &#125; catch(SQLException e) &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是传统的做法，也是以前非Java程序员（如 Delphi、VB 等）常见的做法。这种做法一般在小规模的开发过程中不会产生问题，只要程序员熟悉 Java 语言、了解 JDBC 技术和 MySQL ，可以很快开发出相应的应用程序。</p>
<h3 id="没有-JNDI-的做法存在的问题："><a href="#没有-JNDI-的做法存在的问题：" class="headerlink" title="没有 JNDI 的做法存在的问题："></a>没有 JNDI 的做法存在的问题：</h3><ol>
<li>数据库服务器名称MyDBServer 、用户名和口令都可能需要改变，由此引发JDBC URL需要修改；</li>
<li>数据库可能改用别的产品，如改用DB2或者Oracle，引发JDBC驱动程序包和类名需要修改；</li>
<li>随着实际使用终端的增加，原配置的连接池参数可能需要调整；<h3 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h3>程序员应该不需要关心“具体的数据库后台是什么？JDBC驱动程序是什么？JDBC URL格式是什么？访问数据库的用户名和口令是什么？”等等这些问题，程序员编写的程序应该没有对 JDBC 驱动程序的引用，没有服务器名称，没有用户名称或口令 —— 甚至没有数据库池或连接管理。而是把这些问题交给J2EE容器来配置和管理，程序员只需要对这些配置和管理进行引用即可。</li>
</ol>
<p>由此，就有了JNDI。</p>
<h2 id="用了JNDI之后的做法："><a href="#用了JNDI之后的做法：" class="headerlink" title="用了JNDI之后的做法："></a>用了JNDI之后的做法：</h2><p>首先，在在J2EE容器中配置JNDI参数，定义一个数据源，也就是JDBC引用参数，给这个数据源设置一个名称；然后，在程序中，通过数据源名称引用数据源从而访问后台数据库。<br>具体操作如下（以JBoss为例）：</p>
<h4 id="1、配置数据源"><a href="#1、配置数据源" class="headerlink" title="1、配置数据源:"></a>1、配置数据源:</h4><p>在JBoss的 D:/jboss420GA/docs/examples/jca 文件夹下面，有很多不同数据库引用的数据源定义模板。将其中的 mysql-ds.xml 文件Copy到你使用的服务器下，如 D:/jboss420GA/server/default/deploy。<br>修改 mysql-ds.xml 文件的内容，使之能通过JDBC正确访问你的MySQL数据库，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;datasources&gt;</span><br><span class="line">&lt;local-tx-datasource&gt;</span><br><span class="line">    &lt;jndi-name&gt;MySqlDS&lt;/jndi-name&gt;</span><br><span class="line">    &lt;connection-url&gt;jdbc:mysql://localhost:3306/lw&lt;/connection-url&gt;</span><br><span class="line">    &lt;driver-class&gt;com.mysql.jdbc.Driver&lt;/driver-class&gt;</span><br><span class="line">    &lt;user-name&gt;root&lt;/user-name&gt;</span><br><span class="line">    &lt;password&gt;rootpassword&lt;/password&gt;</span><br><span class="line">&lt;exception-sorter-class-name&gt;org.jboss.resource.adapter.jdbc.vendor.MySQLExceptionSorter&lt;/exception-sorter-class-name&gt;</span><br><span class="line">    &lt;metadata&gt;</span><br><span class="line">       &lt;type-mapping&gt;mySQL&lt;/type-mapping&gt;</span><br><span class="line">    &lt;/metadata&gt;</span><br><span class="line">&lt;/local-tx-datasource&gt;</span><br><span class="line">&lt;/datasources&gt;</span><br></pre></td></tr></table></figure>
<p>这里，定义了一个名为MySqlDS的数据源，其参数包括JDBC的URL，驱动类名，用户名及密码等。</p>
<h4 id="2、在程序中引用数据源："><a href="#2、在程序中引用数据源：" class="headerlink" title="2、在程序中引用数据源："></a>2、在程序中引用数据源：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Connection conn=null;</span><br><span class="line">try &#123;</span><br><span class="line">  Context ctx=new InitialContext();</span><br><span class="line">  Object datasourceRef=ctx.lookup(&quot;java:MySqlDS&quot;); //引用数据源</span><br><span class="line">  DataSource ds=(Datasource)datasourceRef;</span><br><span class="line">  conn=ds.getConnection();</span><br><span class="line">  /* 使用conn进行数据库SQL操作 */</span><br><span class="line">  ......</span><br><span class="line">  c.close();</span><br><span class="line">&#125; </span><br><span class="line">catch(Exception e) &#123;</span><br><span class="line">  e.printStackTrace();</span><br><span class="line">&#125; </span><br><span class="line">finally &#123;</span><br><span class="line">  if(conn!=null) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      conn.close();</span><br><span class="line">    &#125; catch(SQLException e) &#123; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接使用 JDBC 或者通过 JNDI 引用数据源的编程代码量相差无几，但是现在的程序可以不用关心具体 JDBC 参数了。<br>在系统部署后，如果数据库的相关参数变更，只需要重新配置 mysql-ds.xml 修改其中的JDBC参数，只要保证数据源的名称不变，那么程序源代码就无需修改。</p>
<p>由此可见，JNDI避免了程序与数据库之间的紧耦合，使应用更加易于配置、易于部署。</p>
<h2 id="JNDI的扩展："><a href="#JNDI的扩展：" class="headerlink" title="JNDI的扩展："></a>JNDI的扩展：</h2><p>JNDI 在满足了数据源配置的要求的基础上，还进一步扩充了作用：所有与系统外部的资源的引用，都可以通过 JNDI 定义和引用。</p>
<p>所以，在 J2EE 规范中，J2EE 中的资源并不局限于 JDBC 数据源。引用的类型有很多，其中包括资源引用（已经讨论过）、环境实体和 EJB 引用。特别是 EJB 引用，它暴露了 JNDI 在 J2EE 中的另外一项关键角色：查找其他应用程序组件。</p>
<p>EJB 的 JNDI 引用非常类似于 JDBC 资源的引用。在服务趋于转换的环境中，这是一种很有效的方法。可以对应用程序架构中所得到的所有组件进行这类配置管理，从 EJB 组件到 JMS 队列和主题，再到简单配置字符串或其他对象，这可以降低随时间的推移服务变更所产生的维护成本，同时还可以简化部署，减少集成工作。 外部资源”。</p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>J2EE 规范要求所有 J2EE 容器都要提供 JNDI 规范的实现。JNDI 在 J2EE 中的角色就是“交换机” —— J2EE 组件在运行时间接地查找其他组件、资源或服务的通用机制。在多数情况下，提供 JNDI 供应者的容器可以充当有限的数据存储，这样管理员就可以设置应用程序的执行属性，并让其他应用程序引用这些属性（Java 管理扩展（Java Management Extensions，JMX）也可以用作这个目的）。JNDI 在 J2EE 应用程序中的主要角色就是提供间接层，这样组件就可以发现所需要的资源，而不用了解这些间接性。</p>
<p>在 J2EE 中，JNDI 是把 J2EE 应用程序合在一起的粘合剂，JNDI 提供的间接寻址允许跨企业交付可伸缩的、功能强大且很灵活的应用程序。这是 J2EE 的承诺，而且经过一些计划和预先考虑，这个承诺是完全可以实现的。</p>
<p>引用至：<a href="http://blog.csdn.net/zhaosg198312/article/details/3979435" target="_blank" rel="noopener">http://blog.csdn.net/zhaosg198312/article/details/3979435</a></p>
<p>JNDI数据源的配置:<a href="http://www.cnblogs.com/xdp-gacl/p/3951952.html" target="_blank" rel="noopener">http://www.cnblogs.com/xdp-gacl/p/3951952.html</a></p>
<p>关于在Tomcat中如何配置DataSource，可以参考文档:<a href="http://tomcat.apache.org/tomcat-5.5-doc/jndi-datasource-examples-howto.html" target="_blank" rel="noopener">http://tomcat.apache.org/tomcat-5.5-doc/jndi-datasource-examples-howto.html。</a></p>
<p>关于在Tomcat中如何配置其他JNDI服务，可以参考文档:<a href="http://tomcat.apache.org/tomcat-5.5-doc/jndi-resources-howto.html" target="_blank" rel="noopener">http://tomcat.apache.org/tomcat-5.5-doc/jndi-resources-howto.html。</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
        
<div class="counter-tag counter">
    <span id="/2017/09/16/JNDI 是什么/" class="leancloud_visitors post-title-link" style="font-size: 12px" data-flag-title="JNDI 是什么">
         &nbsp;
        view
    </span>
</div>

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>


 








  
    <article id="post-JDBC" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/15/JDBC/" class="article-date">
  	<time datetime="2017-09-14T16:00:00.000Z" itemprop="datePublished">2017-09-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/15/JDBC/">
        JDBC
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是JDBC"><a href="#什么是JDBC" class="headerlink" title="什么是JDBC"></a>什么是JDBC</h2><p>JDBC（Java DataBase Connectivity,java数据库连接）是一种用于执行SQL语句的Java API，可以为多种关系数据库提供统一访问，它由一组用Java语言编写的类和接口组成。JDBC提供了一种基准，据此可以构建更高级的工具和接口，使数据库开发人员能够编写数据库应用程序，同时，JDBC也是个商标名。</p>
<h2 id="JDBC-的使用"><a href="#JDBC-的使用" class="headerlink" title="JDBC 的使用"></a>JDBC 的使用</h2><p>建立一个JDBC应用程序，本教程中以Java连接MySQL为一个示例：</p>
<ol>
<li>导入包，在程序中包含数据库编程所需的JDBC类。大多数情况下，使用 import java.sql.*</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import java.sql.*;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>注册JDBC驱动程序，需要初始化驱动程序，这样就可以打开与数据库的通信。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(&quot;com.mysql.jdbc.Driver&quot;);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>打开一个连接，使用DriverManager.getConnection()方法来创建一个Connection对象，它代表一个数据库的物理连接。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static final String USER = &quot;root&quot;; //用户名</span><br><span class="line">static final String PASS = &quot;pwd123456&quot;; //密码</span><br><span class="line">System.out.println(&quot;Connecting to database...&quot;);</span><br><span class="line">conn = DriverManager.getConnection(DB_URL,USER,PASS); //上面的名字可以自定义的  但是这里要写对</span><br></pre></td></tr></table></figure>
<p>4.执行一个查询， 需要使用一个类型为Statement或PreparedStatement的对象，并提交一个SQL语句到数据库执行查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(&quot;Creating statement...&quot;);</span><br><span class="line">stmt = conn.createStatement();</span><br><span class="line">String sql;</span><br><span class="line">sql = &quot;SELECT id, first, last, age FROM Employees&quot;;</span><br><span class="line">ResultSet rs = stmt.executeQuery(sql);</span><br></pre></td></tr></table></figure>
<p>如果要执行一个SQL语句：UPDATE，INSERT或DELETE语句，那么需要下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(&quot;Creating statement...&quot;);</span><br><span class="line">stmt = conn.createStatement();</span><br><span class="line">String sql;</span><br><span class="line">sql = &quot;DELETE FROM Employees&quot;;</span><br><span class="line">ResultSet rs = stmt.executeUpdate(sql);</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><p>获取结果，可以使用适当的ResultSet.getXXX()方法来检索的数据结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">while(rs.next())&#123;</span><br><span class="line">    //Retrieve by column name</span><br><span class="line">    int id  = rs.getInt(&quot;id&quot;);</span><br><span class="line">    int age = rs.getInt(&quot;age&quot;);</span><br><span class="line">    String first = rs.getString(&quot;first&quot;);</span><br><span class="line">    String last = rs.getString(&quot;last&quot;);</span><br><span class="line"></span><br><span class="line">    //Display values</span><br><span class="line">    System.out.print(&quot;ID: &quot; + id);</span><br><span class="line">    System.out.print(&quot;, Age: &quot; + age);</span><br><span class="line">    System.out.print(&quot;, First: &quot; + first);</span><br><span class="line">    System.out.println(&quot;, Last: &quot; + last);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>清理环境资源，在使用JDBC与数据交互操作数据库中的数据后，应该明确地关闭所有的数据库资源以减少资源的浪费，对依赖于JVM的垃圾收集。</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rs.close();</span><br><span class="line">stmt.close();</span><br><span class="line">conn.close();</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>完整示例。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">// 1. </span><br><span class="line">import java.sql.*;</span><br><span class="line"></span><br><span class="line">public class FirstExample &#123;</span><br><span class="line">   //注册驱动</span><br><span class="line">   static final String JDBC_DRIVER = &quot;com.mysql.jdbc.Driver&quot;;  </span><br><span class="line">   static final String DB_URL = &quot;jdbc:mysql://localhost/test&quot;;</span><br><span class="line"></span><br><span class="line">   //数据库名和密码自己修改</span><br><span class="line">   static final String USER = &quot;username&quot;;</span><br><span class="line">   static final String PASS = &quot;password&quot;;</span><br><span class="line"></span><br><span class="line">   public static void main(String[] args) &#123;</span><br><span class="line">       Connection conn = null;</span><br><span class="line">       Statement stmt = null;</span><br><span class="line">       try&#123;</span><br><span class="line">          // 2.</span><br><span class="line">          Class.forName(&quot;com.mysql.jdbc.Driver&quot;);</span><br><span class="line">          //3.</span><br><span class="line">          conn = DriverManager.getConnection(DB_URL,USER,PASS);</span><br><span class="line">          //4.</span><br><span class="line">          stmt = conn.createStatement();</span><br><span class="line">          String sql;</span><br><span class="line">          sql = &quot;SELECT id, first, last, age FROM Employees&quot;;</span><br><span class="line">          ResultSet rs = stmt.executeQuery(sql);</span><br><span class="line">          //5.</span><br><span class="line">          while(rs.next())&#123;</span><br><span class="line">             int id  = rs.getInt(&quot;id&quot;);</span><br><span class="line">             int age = rs.getInt(&quot;age&quot;);</span><br><span class="line">             String first = rs.getString(&quot;first&quot;);</span><br><span class="line">             String last = rs.getString(&quot;last&quot;);</span><br><span class="line">             </span><br><span class="line">             System.out.print(&quot;ID: &quot; + id);</span><br><span class="line">             System.out.print(&quot;, Age: &quot; + age);</span><br><span class="line">             System.out.print(&quot;, First: &quot; + first);</span><br><span class="line">             System.out.println(&quot;, Last: &quot; + last);</span><br><span class="line">          &#125;</span><br><span class="line">          //6.</span><br><span class="line">          rs.close();</span><br><span class="line">          stmt.close();</span><br><span class="line">          conn.close();</span><br><span class="line">       &#125;catch(SQLException se)&#123;</span><br><span class="line">       // 异常不要这么处理  不好，要携带异常描述和原因。有日志要用日志输出。</span><br><span class="line">          se.printStackTrace()；</span><br><span class="line">       &#125;catch(Exception e)&#123;</span><br><span class="line">          e.printStackTrace();// 同上</span><br><span class="line">       &#125;finally&#123;</span><br><span class="line">          try&#123;</span><br><span class="line">             if(stmt!=null)</span><br><span class="line">                stmt.close();</span><br><span class="line">          &#125;catch(SQLException se2)&#123;</span><br><span class="line">            //自定义后续处理，这里不写了</span><br><span class="line">          &#125;</span><br><span class="line">          try&#123;</span><br><span class="line">             if(conn!=null)</span><br><span class="line">                conn.close();</span><br><span class="line">          &#125;catch(SQLException se)&#123;</span><br><span class="line">             se.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="JDBC-的数据类型"><a href="#JDBC-的数据类型" class="headerlink" title="JDBC 的数据类型"></a>JDBC 的数据类型</h2><table>
<thead>
<tr>
<th>SQL</th>
<th>JDBC\JAVA</th>
<th>setXXX</th>
<th>updateXXX</th>
</tr>
</thead>
<tbody>
<tr>
<td>VARCHAR</td>
<td>java.lang.String</td>
<td>setString</td>
<td>updateString</td>
</tr>
<tr>
<td>CHAR</td>
<td>java.lang.String</td>
<td>setString</td>
<td>updateString</td>
</tr>
<tr>
<td>LONGVARCHAR</td>
<td>java.lang.String</td>
<td>setString</td>
<td>updateString</td>
</tr>
<tr>
<td>BIT</td>
<td>boolean</td>
<td>setBoolean</td>
<td>updateBoolean</td>
</tr>
<tr>
<td>NUMERIC</td>
<td>java.math.BigDecimal</td>
<td>setBigDecimal</td>
<td>updateBigDecimal</td>
</tr>
<tr>
<td>TINYINT</td>
<td>byte</td>
<td>setByte</td>
<td>updateByte</td>
</tr>
<tr>
<td>SMALLINT</td>
<td>short</td>
<td>setShort</td>
<td>updateShort</td>
</tr>
<tr>
<td>INTEGER</td>
<td>int</td>
<td>setInt</td>
<td>updateInt</td>
</tr>
<tr>
<td>BIGINT</td>
<td>long</td>
<td>setLong</td>
<td>updateLong</td>
</tr>
<tr>
<td>REAL</td>
<td>float</td>
<td>setFloat</td>
<td>updateFloat</td>
</tr>
<tr>
<td>FLOAT</td>
<td>float</td>
<td>setFloat</td>
<td>updateFloat</td>
</tr>
<tr>
<td>DOUBLE</td>
<td>double</td>
<td>setDouble</td>
<td>updateDouble</td>
</tr>
<tr>
<td>VARBINARY</td>
<td>byte[ ]</td>
<td>setBytes</td>
<td>updateBytes</td>
</tr>
<tr>
<td>BINARY</td>
<td>byte[ ]</td>
<td>setBytes</td>
<td>updateBytes</td>
</tr>
<tr>
<td>DATE</td>
<td>java.sql.Date</td>
<td>setDate</td>
<td>updateDate</td>
</tr>
<tr>
<td>TIME</td>
<td>java.sql.Time</td>
<td>setTime</td>
<td>updateTime</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>java.sql.Timestamp</td>
<td>setTimestamp</td>
<td>updateTimestamp</td>
</tr>
<tr>
<td>CLOB</td>
<td>java.sql.Clob</td>
<td>setClob</td>
<td>updateClob</td>
</tr>
<tr>
<td>BLOB</td>
<td>java.sql.Blob</td>
<td>setBlob</td>
<td>updateBlob</td>
</tr>
<tr>
<td>ARRAY</td>
<td>java.sql.Array</td>
<td>setARRAY</td>
<td>updateARRAY</td>
</tr>
<tr>
<td>REF</td>
<td>java.sql.Ref</td>
<td>SetRef</td>
<td>updateRef</td>
</tr>
<tr>
<td>STRUCT</td>
<td>java.sql.Struct</td>
<td>SetStruct</td>
<td>updateStruct</td>
</tr>
</tbody>
</table>
<p>在JDBC3.0中增强支持BLOB，CLOB，ARRAY，REF等数据类型。ResultSet对象可调用UPDATEBLOB()，updateCLOB()，updateArray()和updateRef()方法，使您可以在数据库服务器上直接操作相应的数据。</p>
<p>对于setXXX()和updateXXX()方法，可以转换成特定的Java类型到特定的JDBC数据类型。而使用setObject()和updateObject()方法，几乎所有的Java类型映射到JDBC数据类型。</p>
<p>ResultSet对象提供相应的getXXX()方法为每个数据类型来检索列值。每一种类型方法，可以使用与列名或由列的序号位置来获取列的数据。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
        
<div class="counter-tag counter">
    <span id="/2017/09/15/JDBC/" class="leancloud_visitors post-title-link" style="font-size: 12px" data-flag-title="JDBC">
         &nbsp;
        view
    </span>
</div>

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>


 








  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2019 一只程序猿
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>

    </div>
	
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>

 
  </div>
 
</body>
</html>
